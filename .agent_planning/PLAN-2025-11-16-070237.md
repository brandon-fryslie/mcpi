# MCPI v2.0 Implementation Plan - Path to Full Operational Status

**Generated**: 2025-11-16 07:02:37
**Source STATUS**: STATUS-2025-11-16-070000.md
**Spec Version**: CLAUDE.md (last modified 2025-11-16)
**Current State**: 87% operational (603/692 tests passing)
**Target State**: 98%+ operational, production-ready v2.0 release

---

## Executive Summary

### Current State Analysis

MCPI is functionally complete but blocked by an incomplete file rename migration (registry.json → catalog.json). The architecture is solid, core features work, and only **30 minutes of focused work** separates the project from production readiness.

**Key Metrics**:
- Test Pass Rate: 87% (603 passing / 74 failing / 15 skipped)
- Critical Blocker: Parameter naming inconsistency (`registry_path` vs `catalog_path`)
- Working Features: CLI list/search/enable/disable, TUI, scope management
- Broken Features: Info command, add command (catalog lookup failures)

**Evidence from STATUS Report**:
- Old files still exist: `data/registry.json`, `data/registry.cue` (should be deleted)
- Tests expect `catalog_path` parameter (line 104, test_registry_dependency_injection.py)
- Code provides `registry_path` parameter (line 134, catalog.py)
- Impact: 74 tests failing due to API mismatch

### Total Gap Analysis

**P0 (Critical - Blocking Ship)**: 30 minutes of work
**P1 (High - Should Have)**: 2.5 hours of work
**P2 (Medium - Nice to Have)**: 2-3 weeks of work
**P3 (Low - Future)**: 2-3 weeks of work

**Recommended Focus**: Fix P0 immediately, complete P1 before ship, defer P2/P3 to post-v2.0

### Dependency Graph

```
P0-1 (Delete Old Files)
  ↓
P0-2 (Rename Parameter) ← CRITICAL PATH
  ↓
P0-3 (Verify Tests) ← 74 tests unblocked
  ↓
P1-1 (CLI Verification)
  ↓
P1-2 (Documentation)
  ↓
SHIP v2.0
  ↓
P2-1 (DIP Phase 2)
  ↓
P3-1 (DIP Phases 3-4)
```

### Recommended Sprint Planning

**Sprint 1 (TODAY - Critical Fix)**: P0 items only (30 min)
**Sprint 2 (THIS WEEK - Polish)**: P1 items (2.5 hrs)
**Sprint 3 (NEXT MONTH - Architecture)**: P2 items (2-3 weeks)
**Future Backlog**: P3 items

---

## Backlog by Priority

## [P0] Delete Old Registry Files

**Status**: Not Started
**Effort**: Small (5 minutes)
**Dependencies**: None
**Spec Reference**: Architecture > Registry System (CLAUDE.md lines 246-251) • **Status Reference**: STATUS-2025-11-16-070000.md section 1.2

### Description

Delete the old `registry.json` and `registry.cue` files that are superseded by `catalog.json` and `catalog.cue`. These files cause test failures because tests verify that the migration is complete.

**Evidence from STATUS**:
```
$ ls -la data/
-rw------- catalog.cue       # NEW schema
-rw------- catalog.json      # NEW data (19 servers)
-rw-r--r-- registry.cue      # OLD schema (SHOULD BE DELETED)
-rw------- registry.json     # OLD data (SHOULD BE DELETED)
```

**Test Failure**:
```
AssertionError: Old registry.json still exists at .../data/registry.json.
Should be renamed to catalog.json
```

### Acceptance Criteria

- [ ] File `data/registry.json` does not exist
- [ ] File `data/registry.cue` does not exist
- [ ] File `data/catalog.json` exists and contains 19 servers
- [ ] File `data/catalog.cue` exists and is valid CUE schema
- [ ] Test `test_old_registry_files_do_not_exist` passes
- [ ] Changes committed to git

### Technical Notes

**Commands**:
```bash
cd /Users/bmf/icode/mcpi
rm data/registry.json
rm data/registry.cue
git add data/
git status  # Verify only registry.* deleted
```

**Verification**:
```bash
pytest tests/test_catalog_rename.py::test_old_registry_files_do_not_exist -v
# Expected: PASSED
```

**Risk**: MINIMAL - Files are superseded, safe to delete

---

## [P0] Rename registry_path to catalog_path

**Status**: Not Started
**Effort**: Small (20 minutes)
**Dependencies**: P0-1 (Delete Old Files)
**Spec Reference**: Registry System > catalog.py (CLAUDE.md line 248) • **Status Reference**: STATUS-2025-11-16-070000.md section 4.1

### Description

Rename all occurrences of `registry_path` to `catalog_path` in the ServerCatalog class to match the test API. This is a pure rename - no logic changes required.

**Evidence from STATUS**:
```python
# File: src/mcpi/registry/catalog.py (lines 130-145)
class ServerCatalog:
    def __init__(
        self, registry_path: Path, validate_with_cue: bool = True
    ):
        """Initialize the catalog with registry path."""
        self.registry_path = registry_path  # BUG: Should be catalog_path
```

**Test Expectations**:
```python
# File: tests/test_registry_dependency_injection.py (line 104)
catalog = ServerCatalog(
    catalog_path=minimal_registry_file,  # Tests expect catalog_path
    validate_with_cue=False
)
# FAILS: TypeError: unexpected keyword argument 'catalog_path'
```

**Impact**: Fixes 74 failing tests (11% of suite)

### Acceptance Criteria

- [ ] Parameter `__init__(self, catalog_path: Path, ...)` renamed
- [ ] Instance variable `self.catalog_path` renamed
- [ ] All references within `catalog.py` updated (estimated 10 occurrences)
- [ ] Factory function `create_default_catalog()` updated if needed
- [ ] Factory function `create_test_catalog()` updated if needed
- [ ] All tests in `test_registry_dependency_injection.py` pass (10 tests)
- [ ] All tests in `test_catalog_rename.py` pass (6 tests)
- [ ] No new test failures introduced
- [ ] Black formatting passes
- [ ] Code committed to git

### Technical Notes

**Files to Modify**:
1. `src/mcpi/registry/catalog.py`
   - Line 134: Parameter name in `__init__`
   - Line 142: Instance variable assignment
   - Line 157+: Any other references to `self.registry_path`
   - Line 215+: Factory function `create_default_catalog()` if it references the path
   - Line 225+: Factory function `create_test_catalog()` if it references the path

**Search Strategy**:
```bash
cd /Users/bmf/icode/mcpi
grep -n "registry_path" src/mcpi/registry/catalog.py
# Review each occurrence and rename to catalog_path
```

**Testing Strategy**:
```bash
# Run specific failing test suites
pytest tests/test_catalog_rename.py -v
pytest tests/test_registry_dependency_injection.py -v

# Expected: All tests should pass
```

**Edge Cases**:
- Comments mentioning "registry path" should be updated to "catalog path"
- Error messages mentioning registry_path should be updated
- Docstrings should be updated for consistency

**Risk**: LOW - Pure rename, no logic changes

---

## [P0] Verify Full Test Suite Passes

**Status**: Not Started
**Effort**: Small (5 minutes)
**Dependencies**: P0-2 (Rename Parameter)
**Spec Reference**: Testing Strategy (CLAUDE.md lines 280-286) • **Status Reference**: STATUS-2025-11-16-070000.md section 3.1

### Description

Run the full test suite to verify that the catalog rename fixes all 74 failing tests and achieves 98%+ pass rate. This is a verification step to ensure no regressions.

**Expected Outcome**:
- Test pass rate: 98%+ (677+ tests passing)
- Test failure rate: <2% (remaining failures are known skips or edge cases)
- No new test failures introduced

**Evidence from STATUS**:
```
Current: 603 passing / 74 failing / 15 skipped (87%)
Expected: 677 passing / 0 failing / 15 skipped (98%+)
```

### Acceptance Criteria

- [ ] Full test suite passes with `pytest --tb=no -q`
- [ ] Test pass rate is 98% or higher
- [ ] All catalog-related tests pass (test_catalog_rename.py)
- [ ] All DIP tests pass (test_registry_dependency_injection.py)
- [ ] All CLI integration tests pass
- [ ] All functional workflow tests pass
- [ ] Coverage report shows no regressions
- [ ] Black formatting passes on all code
- [ ] Test results documented in commit message

### Technical Notes

**Test Commands**:
```bash
cd /Users/bmf/icode/mcpi

# Run full suite with minimal output
pytest --tb=no -q
# Expected: 677+ passed, 15 skipped in X.XXs

# Run with coverage
pytest --cov=src/mcpi --cov-report=term
# Expected: Coverage 60-70% (up from 9%)

# Run specific test categories
pytest tests/test_catalog_rename.py -v
pytest tests/test_registry_dependency_injection.py -v
pytest tests/test_cli_scope_features.py -v
pytest tests/test_enable_disable_bugs.py -v

# Format check
black --check src/ tests/
# Expected: All done! ✨
```

**Success Criteria**:
- Zero failures in catalog tests
- Zero failures in DIP tests
- Pass rate 98%+ overall
- No new failures introduced

**Risk**: MINIMAL - This is verification only

---

## [P1] Verify CLI Commands Work End-to-End

**Status**: Not Started
**Effort**: Small (10 minutes)
**Dependencies**: P0-3 (Test Suite Passes)
**Spec Reference**: CLI Interface (CLAUDE.md lines 253-258) • **Status Reference**: STATUS-2025-11-16-070000.md section 13.1

### Description

Manually verify that all CLI commands work correctly after the catalog rename fix. This ensures production readiness beyond just test passing.

**Commands to Test**:
1. `mcpi info playwright` - Should show server details from catalog
2. `mcpi add puppeteer --dry-run` - Should show what would be added
3. `mcpi search browser` - Should show 2 results (playwright, puppeteer)
4. `mcpi list --scope user-internal` - Should show 3 installed servers
5. `mcpi fzf` - Should launch interactive TUI
6. `mcpi enable browser-tools --scope user-internal` - Should enable server
7. `mcpi disable browser-tools --scope user-internal` - Should disable server
8. `mcpi status` - Should show overall system status

### Acceptance Criteria

- [ ] `mcpi info playwright` displays server metadata correctly
- [ ] `mcpi info browser-tools` finds server in catalog (was broken)
- [ ] `mcpi add puppeteer --dry-run` shows installation plan
- [ ] `mcpi search browser` returns 2 results with correct descriptions
- [ ] `mcpi list --scope user-internal` shows all installed servers
- [ ] `mcpi fzf` launches without errors and displays keyboard shortcuts
- [ ] `mcpi enable/disable` commands work for all supported scopes
- [ ] `mcpi status` shows accurate system state
- [ ] All commands return appropriate exit codes (0 for success)
- [ ] Error messages are clear and actionable
- [ ] Rich console output renders correctly

### Technical Notes

**Test Script**:
```bash
#!/bin/bash
# Manual CLI verification script

set -e  # Exit on error

echo "Testing CLI commands..."

# Test 1: Info command (was broken)
echo "1. Testing info command..."
mcpi info playwright
mcpi info browser-tools

# Test 2: Add command (dry run)
echo "2. Testing add command..."
mcpi add puppeteer --dry-run

# Test 3: Search command
echo "3. Testing search command..."
mcpi search browser

# Test 4: List command
echo "4. Testing list command..."
mcpi list --scope user-internal

# Test 5: Enable/disable
echo "5. Testing enable/disable..."
mcpi disable browser-tools --scope user-internal
mcpi list --scope user-internal  # Should show disabled
mcpi enable browser-tools --scope user-internal
mcpi list --scope user-internal  # Should show enabled

# Test 6: TUI (requires manual verification)
echo "6. Launching TUI (press q to quit)..."
mcpi fzf

# Test 7: Status
echo "7. Testing status command..."
mcpi status

echo "All CLI tests passed!"
```

**Manual Verification Checklist**:
- [ ] Info command shows correct server metadata
- [ ] Add command shows correct installation method
- [ ] Search returns accurate results
- [ ] List shows correct server states (enabled/disabled)
- [ ] TUI renders correctly and keyboard shortcuts work
- [ ] Status command shows accurate system state

**Risk**: LOW - This is verification only, no code changes

---

## [P1] Add Enable/Disable Documentation to CLAUDE.md

**Status**: Not Started
**Effort**: Small (30 minutes)
**Dependencies**: P1-1 (CLI Verification)
**Spec Reference**: Documentation (CLAUDE.md) • **Status Reference**: STATUS-2025-11-16-070000.md section 6.2

### Description

Add comprehensive documentation to CLAUDE.md explaining the enable/disable mechanisms by scope. This was implemented for v2.0 but never documented.

**Content Source**: Ship checklist at `.agent_planning/SHIP-CHECKLIST-v2.0-USER-INTERNAL-DISABLE-2025-11-13.md` (lines 169-214)

**Target Location**: New section after "Scope-Based Configuration" in CLAUDE.md

### Acceptance Criteria

- [ ] New section "Enable/Disable Mechanisms by Scope" added to CLAUDE.md
- [ ] Documents ArrayBased handler (user-internal, user-mcp scopes)
- [ ] Documents FileTracked handler (user-global, user-local scopes)
- [ ] Includes examples of enable/disable commands for each scope
- [ ] Explains tracking file format (`.mcpi-disabled-servers-*.json`)
- [ ] Links to relevant test files for reference
- [ ] Section placed logically in document structure
- [ ] Markdown formatting is consistent with rest of CLAUDE.md
- [ ] Code examples are syntax-highlighted
- [ ] Documentation reviewed for clarity and accuracy
- [ ] Changes committed to git

### Technical Notes

**Section Outline**:
```markdown
### Enable/Disable Mechanisms by Scope

MCPI supports enabling and disabling servers on a per-scope basis with two different mechanisms:

**ArrayBased Handler** (user-internal, user-mcp):
- Scopes where servers are defined as JSON arrays
- Enable: Server present in array
- Disable: Server removed from array
- Example: `~/.claude/settings.json` (user-internal)

**FileTracked Handler** (user-global, user-local):
- Scopes where servers are defined as JSON objects
- Enable: Remove from tracking file
- Disable: Add to tracking file
- Tracking file: `.mcpi-disabled-servers-{scope}.json`
- Example: `.claude/.mcpi-disabled-servers-global.json`

**Examples**:
[Include command examples from ship checklist]

**Implementation Details**:
[Link to relevant code and tests]
```

**Source Material**:
- Ship checklist: `.agent_planning/SHIP-CHECKLIST-v2.0-USER-INTERNAL-DISABLE-2025-11-13.md`
- Test file: `tests/test_enable_disable_bugs.py`
- Implementation: `src/mcpi/clients/claude_code.py` (lines 162-186)

**Risk**: MINIMAL - Documentation only

---

## [P1] Integration Test Verification

**Status**: Not Started
**Effort**: Medium (2 hours)
**Dependencies**: P0-3 (Test Suite Passes)
**Spec Reference**: Testing Strategy > Integration Tests (CLAUDE.md line 283) • **Status Reference**: STATUS-2025-11-16-070000.md section 6.2

### Description

Verify that installer workflows work correctly now that catalog is fixed. The STATUS report indicates these tests were failing due to catalog issues, so they need explicit verification after the fix.

**Test Files to Verify**:
1. `tests/test_installer_workflows_integration.py` - Full installer workflows
2. `tests/test_cli_scope_features.py` - Scope-based operations
3. `tests/test_server_lifecycle_workflow.py` - Add/remove workflows
4. `tests/test_cross_scope_operations.py` - Multi-scope operations

### Acceptance Criteria

- [ ] All installer workflow tests pass
- [ ] All CLI scope feature tests pass
- [ ] All server lifecycle tests pass
- [ ] All cross-scope operation tests pass
- [ ] Test coverage for installers is adequate (>70%)
- [ ] No regressions in existing integration tests
- [ ] Test execution time is reasonable (<5 minutes total)
- [ ] Integration tests documented in test plan
- [ ] Any new issues discovered are logged

### Technical Notes

**Test Commands**:
```bash
# Run installer workflow tests
pytest tests/test_installer_workflows_integration.py -v

# Run CLI scope tests
pytest tests/test_cli_scope_features.py -v

# Run lifecycle tests
pytest tests/test_server_lifecycle_workflow.py -v

# Run cross-scope tests
pytest tests/test_cross_scope_operations.py -v

# Run all integration tests
pytest tests/ -k "integration or workflow or lifecycle" -v
```

**Success Metrics**:
- All tests pass (100% pass rate for integration suite)
- No timeout or flaky tests
- Test output is clear and informative
- Coverage for installer code >70%

**Known Issues to Watch For**:
- Catalog loading failures (should be fixed)
- Server lookup failures (should be fixed)
- Registry data source issues (should be fixed)

**Risk**: LOW - Tests should pass after catalog fix

---

## [P2] DIP Phase 2 - ClaudeCodePlugin Refactoring

**Status**: Not Started
**Effort**: Large (1-2 weeks)
**Dependencies**: P1-2 (Documentation Complete)
**Spec Reference**: DIP Implementation > Phase 2 (CLAUDE.md line 401) • **Status Reference**: DIP_AUDIT-2025-11-07-010149.md section 6

### Description

Refactor ClaudeCodePlugin to use dependency injection for readers, writers, and validators. This is Phase 2 of the DIP audit implementation plan.

**Components to Refactor** (5 items):
1. ClaudeCodePlugin - Inject readers/writers/validators
2. FileBasedScope - Make reader/writer required parameters
3. JSONFileReader/Writer - Add abstraction if needed
4. YAMLSchemaValidator - Add abstraction if needed
5. EnableDisableHandler implementations - Inject dependencies

**Evidence from DIP Audit**:
```python
# Current (WRONG):
def _initialize_scopes(self):
    json_reader = JSONFileReader()      # Hardcoded
    json_writer = JSONFileWriter()      # Hardcoded
    validator = YAMLSchemaValidator()   # Hardcoded

# Target (CORRECT):
def __init__(
    self,
    path_overrides: Optional[Dict[str, Path]] = None,
    reader: ConfigReader,                      # Injected
    writer: ConfigWriter,                      # Injected
    validator: SchemaValidator,                # Injected
):
```

### Acceptance Criteria

- [ ] ClaudeCodePlugin constructor accepts reader/writer/validator
- [ ] FileBasedScope reader/writer are required parameters
- [ ] All protocols (ConfigReader, ConfigWriter, SchemaValidator) properly used
- [ ] Factory functions created for production and test instances
- [ ] All existing tests updated to use new constructors
- [ ] New unit tests created with mocked dependencies
- [ ] No file I/O in true unit tests
- [ ] Test coverage for plugin operations >80%
- [ ] Documentation updated to reflect new patterns
- [ ] All tests pass (no regressions)
- [ ] Black formatting passes
- [ ] Changes committed with descriptive messages

### Technical Notes

**Implementation Steps**:
1. Update ClaudeCodePlugin constructor to accept dependencies
2. Update FileBasedScope to require dependencies
3. Create factory functions for production use
4. Create test factories for testing use
5. Update all test files to use new patterns
6. Write new unit tests with mocks
7. Update documentation

**Files to Modify**:
- `src/mcpi/clients/claude_code.py`
- `src/mcpi/clients/file_based.py`
- `src/mcpi/clients/protocols.py` (if needed)
- `tests/test_claude_code_plugin.py`
- `tests/test_file_based_scope.py`
- `.agent_planning/CLAUDE.md` (update DIP section)

**Reference Implementation**: DIP_AUDIT-2025-11-07-010149.md section 1.5

**Estimated Effort Breakdown**:
- Design and planning: 2 days
- Implementation: 5 days
- Testing: 2 days
- Documentation: 1 day
- Total: 10 days (2 weeks)

**Risk**: MEDIUM - Significant refactoring, but well-documented plan exists

---

## [P2] DIP Phase 2 - ClientRegistry Refactoring

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: P2-1 (ClaudeCodePlugin Refactored)
**Spec Reference**: DIP Implementation > Phase 2 (CLAUDE.md line 401) • **Status Reference**: DIP_AUDIT-2025-11-07-010149.md section 1.3

### Description

Refactor ClientRegistry to support dependency injection for plugin discovery. Allow pre-loaded plugins for testing while maintaining auto-discovery for production.

**Current Problem** (from DIP Audit):
```python
class ClientRegistry:
    def __init__(self) -> None:
        self._plugins = {}
        self._instances = {}
        self._discover_plugins()  # Hardcoded - cannot inject plugins
```

**Target Design**:
```python
class ClientRegistry:
    def __init__(self, plugin_classes: Optional[List[Type[MCPClientPlugin]]] = None):
        self._plugins = {}
        self._instances = {}

        if plugin_classes:
            for plugin_class in plugin_classes:
                self._register_plugin_class(plugin_class)
        else:
            self._discover_plugins()
```

### Acceptance Criteria

- [ ] ClientRegistry accepts optional plugin_classes parameter
- [ ] Auto-discovery still works when no plugins provided
- [ ] Can inject mock plugins for testing
- [ ] PluginDiscovery protocol defined (if needed)
- [ ] Factory functions created for production and test instances
- [ ] All existing tests updated
- [ ] New unit tests with injected mock plugins
- [ ] Test coverage for registry operations >80%
- [ ] Documentation updated
- [ ] All tests pass (no regressions)
- [ ] Changes committed

### Technical Notes

**Implementation Approach**:
1. Add plugin_classes parameter to __init__
2. Conditional logic: inject or auto-discover
3. Create _register_plugin_class helper method
4. Create factory functions
5. Update MCPManager to use factory
6. Update tests to inject mock plugins

**Files to Modify**:
- `src/mcpi/clients/registry.py`
- `src/mcpi/clients/manager.py` (update usage)
- `tests/test_client_registry.py`
- `tests/test_mcp_manager.py`

**Benefits**:
- True unit tests without file system access
- Faster test execution
- Easier mocking in tests
- Better SOLID compliance

**Estimated Effort**: 3-5 days

**Risk**: MEDIUM - Changes core discovery mechanism

---

## [P2] DIP Phase 2 - CLI Factory Pattern

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: P2-2 (ClientRegistry Refactored)
**Spec Reference**: DIP Implementation > Phase 2 (CLAUDE.md line 401) • **Status Reference**: DIP_AUDIT-2025-11-07-010149.md section 1.4

### Description

Refactor CLI helper functions to accept factory functions for creating MCPManager and ServerCatalog. This enables testing CLI commands without touching the file system.

**Current Problem** (from DIP Audit):
```python
def get_mcp_manager(ctx: click.Context) -> MCPManager:
    if "mcp_manager" not in ctx.obj:
        ctx.obj["mcp_manager"] = MCPManager()  # Hardcoded
```

**Target Design**:
```python
def get_mcp_manager(ctx: click.Context, factory=None) -> MCPManager:
    if "mcp_manager" not in ctx.obj:
        if factory is None:
            factory = create_default_manager
        ctx.obj["mcp_manager"] = factory()
```

### Acceptance Criteria

- [ ] get_mcp_manager accepts optional factory parameter
- [ ] get_catalog accepts optional factory parameter
- [ ] Default factories used in production
- [ ] Test factories can be injected for testing
- [ ] All CLI commands updated to use new pattern
- [ ] CLI tests updated to inject test factories
- [ ] CLI tests run without file system access
- [ ] Test coverage for CLI commands >70%
- [ ] Documentation updated
- [ ] All tests pass (no regressions)
- [ ] Changes committed

### Technical Notes

**Implementation Steps**:
1. Add factory parameter to get_mcp_manager
2. Add factory parameter to get_catalog
3. Update all CLI commands to accept factories via ctx.obj
4. Create CLI test fixtures with test factories
5. Update all CLI tests to use injection

**Files to Modify**:
- `src/mcpi/cli.py`
- `tests/test_cli.py`
- `tests/test_cli_scope_features.py`
- `tests/conftest.py` (add CLI test fixtures)

**Testing Pattern**:
```python
def test_list_command():
    def test_manager_factory():
        return MockMCPManager()

    def test_catalog_factory():
        return MockServerCatalog()

    result = runner.invoke(
        cli,
        ["list"],
        obj={
            "manager_factory": test_manager_factory,
            "catalog_factory": test_catalog_factory
        }
    )
```

**Estimated Effort**: 1-2 days

**Risk**: LOW - Well-documented pattern, minimal changes

---

## [P2] DIP Phase 2 - Registry Abstraction

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: P2-3 (CLI Factory Pattern)
**Spec Reference**: DIP Implementation > Phase 2 (CLAUDE.md line 401) • **Status Reference**: DIP_AUDIT-2025-11-07-010149.md section 3.1

### Description

Create RegistryDataSource protocol and implementations to abstract catalog data source. This allows testing with in-memory data and supports future extensibility (database, remote API).

**Target Design** (from DIP Audit):
```python
class RegistryDataSource(Protocol):
    """Protocol for registry data sources."""

    def load(self) -> Dict[str, MCPServer]:
        """Load all servers from data source."""
        ...

    def save(self, servers: Dict[str, MCPServer]) -> bool:
        """Save servers to data source."""
        ...

class FileRegistryDataSource:
    """File-based registry data source."""
    def __init__(self, catalog_path: Path, validator: Optional[CUEValidator] = None):
        ...

class InMemoryRegistryDataSource:
    """In-memory registry data source for testing."""
    def __init__(self, servers: Dict[str, MCPServer]):
        ...
```

### Acceptance Criteria

- [ ] RegistryDataSource protocol defined
- [ ] FileRegistryDataSource implemented
- [ ] InMemoryRegistryDataSource implemented for testing
- [ ] ServerCatalog refactored to use RegistryDataSource
- [ ] Factory functions updated to create appropriate data sources
- [ ] All existing tests updated
- [ ] New unit tests with InMemoryRegistryDataSource
- [ ] Test coverage for catalog operations >80%
- [ ] Documentation updated
- [ ] All tests pass (no regressions)
- [ ] Changes committed

### Technical Notes

**Implementation Steps**:
1. Define RegistryDataSource protocol
2. Implement FileRegistryDataSource
3. Implement InMemoryRegistryDataSource
4. Refactor ServerCatalog to accept data source
5. Update factory functions
6. Update all tests
7. Add documentation

**Files to Create/Modify**:
- `src/mcpi/registry/data_sources.py` (new file)
- `src/mcpi/registry/catalog.py` (refactor)
- `src/mcpi/registry/protocols.py` (add protocol)
- `tests/test_registry_data_sources.py` (new file)
- `tests/test_server_catalog.py` (update)

**Benefits**:
- True unit tests without file I/O
- Supports future extensibility (database backend)
- Better separation of concerns
- Easier testing

**Estimated Effort**: 3-5 days

**Risk**: MEDIUM - Significant refactoring of catalog logic

---

## [P2] DIP Phase 2 - TUI Factory Refactoring

**Status**: Not Started
**Effort**: Small (1 day)
**Dependencies**: None (independent)
**Spec Reference**: DIP Implementation > Phase 2 (CLAUDE.md line 401) • **Status Reference**: DIP_AUDIT-2025-11-07-010149.md section 1.7

### Description

Refactor TUI factory to accept adapter factory for testing. This is a low-priority item but completes the DIP implementation for Phase 2.

**Current Problem** (from DIP Audit):
```python
def get_tui_adapter(backend: Optional[str] = None) -> TUIAdapter:
    if backend == "fzf":
        return FzfAdapter()  # Hardcoded
```

**Target Design**:
```python
def get_tui_adapter(
    backend: Optional[str] = None,
    adapter_factory: Optional[Callable[[], TUIAdapter]] = None
) -> TUIAdapter:
    if adapter_factory:
        return adapter_factory()
    # ... existing logic
```

### Acceptance Criteria

- [ ] get_tui_adapter accepts optional adapter_factory parameter
- [ ] Default behavior unchanged (uses FzfAdapter)
- [ ] Test factory can be injected
- [ ] TUI tests updated to use injection
- [ ] TUI tests run without external dependencies
- [ ] Test coverage for TUI operations >70%
- [ ] Documentation updated
- [ ] All tests pass (no regressions)
- [ ] Changes committed

### Technical Notes

**Implementation Steps**:
1. Add adapter_factory parameter to get_tui_adapter
2. Create MockTUIAdapter for testing
3. Update TUI tests to inject mock adapter
4. Add documentation

**Files to Modify**:
- `src/mcpi/tui/factory.py`
- `tests/test_tui.py`
- `tests/mocks/tui.py` (new file)

**Estimated Effort**: 1 day

**Risk**: LOW - Minimal changes, independent of other work

---

## [P3] DIP Phases 3-4 - Remaining Components

**Status**: Not Started
**Effort**: Large (2-3 weeks)
**Dependencies**: P2-5 (DIP Phase 2 Complete)
**Spec Reference**: DIP Implementation > Phases 3-4 (CLAUDE.md lines 402-403) • **Status Reference**: DIP_AUDIT-2025-11-07-010149.md section 6

### Description

Complete the DIP audit by implementing dependency injection for the remaining 6 components identified in the audit. This is non-critical work that can be deferred to post-v2.0 release.

**Components** (from DIP Audit):
- Phase 3 (P2): 4 components - 1-2 weeks
  - PluginDiscovery abstraction
  - SchemaValidator injection
  - EnableDisableHandler refactoring
  - PathResolver abstraction
- Phase 4 (P3): 2 components - 1 week
  - Factory pattern consistency
  - Code organization cleanup

### Acceptance Criteria

- [ ] All Phase 3 components refactored with DIP
- [ ] All Phase 4 components refactored with DIP
- [ ] All protocols defined and used consistently
- [ ] All factory functions follow consistent pattern
- [ ] Test coverage >80% for all refactored components
- [ ] Documentation updated throughout
- [ ] All tests pass (no regressions)
- [ ] DIP audit marked as complete
- [ ] Changes committed with detailed messages

### Technical Notes

**Approach**:
1. Follow same pattern as Phase 2
2. Define protocols first
3. Implement concrete classes
4. Refactor constructors
5. Create factory functions
6. Update tests
7. Update documentation

**Reference**: DIP_AUDIT-2025-11-07-010149.md sections 2.2, 2.3, 3.2, 3.3

**Estimated Effort**: 2-3 weeks (10-15 days)

**Risk**: LOW - Non-critical, can be deferred

---

## [P3] Planning Document Cleanup

**Status**: Not Started
**Effort**: Small (20 minutes)
**Dependencies**: P1-2 (Documentation Complete)
**Spec Reference**: N/A • **Status Reference**: STATUS-2025-11-16-070000.md section 10

### Description

Clean up the `.agent_planning` directory by archiving completed work and superseded documents. The STATUS report indicates 58 markdown files exist, which is excessive.

**Cleanup Strategy**:
1. Move completed work to `.agent_planning/completed/`
2. Move superseded documents to `.agent_planning/archive/2025-11/`
3. Keep only 4 most recent STATUS files
4. Keep only active planning documents

### Acceptance Criteria

- [ ] Directory `.agent_planning/completed/` created
- [ ] Directory `.agent_planning/archive/2025-11/` created
- [ ] Completed work moved to `completed/`
- [ ] Superseded documents moved to `archive/2025-11/`
- [ ] Only 4 most recent STATUS files remain in root
- [ ] Only active planning documents remain in root
- [ ] README.md added to each subdirectory explaining contents
- [ ] Changes committed to git

### Technical Notes

**Files to Move to `completed/`**:
```bash
mv STATUS-USER-INTERNAL-DISABLE-FINAL-2025-11-13.md completed/
mv SHIP-CHECKLIST-v2.0-USER-INTERNAL-DISABLE-2025-11-13.md completed/
mv PLANNING-SUMMARY-v2.0-SHIP-READY-2025-11-13.md completed/
```

**Files to Move to `archive/2025-11/`**:
```bash
mv STATUS-2025-11-09-*.md archive/2025-11/
mv PLAN-2025-11-09-*.md archive/2025-11/
mv PLANNING-SUMMARY-2025-11-09-*.md archive/2025-11/
mv STATUS-2025-11-13-DISABLE-EVALUATION.md archive/2025-11/
```

**Files to Keep**:
- `DIP_AUDIT-2025-11-07-010149.md` (ongoing work)
- 4 most recent STATUS files
- This planning document
- Active sprint documents

**Risk**: MINIMAL - Housekeeping only

---

## Risk Assessment

### High-Risk Items

**None** - All critical work is low-risk rename/cleanup

### Medium-Risk Items

1. **DIP Phase 2 Refactoring** (P2-1 through P2-5)
   - Risk: Breaking changes to core components
   - Mitigation: Comprehensive test suite, incremental changes, factory pattern
   - Impact if delayed: Can ship v2.0 without this work

### Low-Risk Items

1. **Catalog Rename** (P0-1, P0-2, P0-3)
   - Risk: Minimal - pure rename, no logic changes
   - Mitigation: Tests verify correctness
   - Impact: Unblocks 74 failing tests

2. **CLI Verification** (P1-1)
   - Risk: Minimal - verification only
   - Mitigation: Manual testing checklist
   - Impact: Ensures production readiness

3. **Documentation** (P1-2, P3-2)
   - Risk: None - documentation only
   - Mitigation: N/A
   - Impact: Improves developer experience

### Uncertain Items

**None** - All work is well-defined with clear acceptance criteria

---

## Recommended Implementation Order

### Sprint 1: Critical Path (TODAY - 30 minutes)

**Goal**: Unblock 74 failing tests, achieve 98%+ test pass rate

1. P0-1: Delete old registry files (5 min)
2. P0-2: Rename registry_path to catalog_path (20 min)
3. P0-3: Verify full test suite passes (5 min)

**Deliverable**: 98%+ test pass rate, catalog rename complete

### Sprint 2: Polish and Ship Prep (THIS WEEK - 2.5 hours)

**Goal**: Production-ready v2.0 release

1. P1-1: Verify CLI commands work (10 min)
2. P1-2: Add enable/disable documentation (30 min)
3. P1-3: Integration test verification (2 hours)

**Deliverable**: Production-ready v2.0 with documentation

### Sprint 3: Architecture Improvements (NEXT MONTH - 2-3 weeks)

**Goal**: Complete DIP Phase 2 implementation

1. P2-1: ClaudeCodePlugin refactoring (1-2 weeks)
2. P2-2: ClientRegistry refactoring (3-5 days)
3. P2-3: CLI factory pattern (1-2 days)
4. P2-4: Registry abstraction (3-5 days)
5. P2-5: TUI factory refactoring (1 day)

**Deliverable**: DIP Phase 2 complete, improved testability

### Future Backlog: Long-term Improvements

1. P3-1: DIP Phases 3-4 (2-3 weeks)
2. P3-2: Planning document cleanup (20 min)

**Deliverable**: Full DIP compliance, clean repository

---

## Success Metrics

### Sprint 1 Success Criteria

- [ ] Test pass rate ≥ 98%
- [ ] Zero catalog-related test failures
- [ ] All DIP tests passing
- [ ] Black formatting clean
- [ ] Changes committed to git

### Sprint 2 Success Criteria

- [ ] All CLI commands verified working
- [ ] Enable/disable documentation complete
- [ ] Integration tests 100% pass rate
- [ ] Ready to ship v2.0

### Sprint 3 Success Criteria

- [ ] DIP Phase 2 complete (5 components)
- [ ] Test coverage >80% for refactored components
- [ ] No file I/O in unit tests
- [ ] All tests passing

### Overall Project Success

- [ ] v2.0 shipped with 98%+ test pass rate
- [ ] All core features documented
- [ ] DIP implementation on track
- [ ] Repository clean and organized

---

## Blockers and Questions

### Current Blockers

**None** - All work is unblocked and ready to proceed

### Open Questions

1. **Should we ship v2.0 before completing DIP Phase 2?**
   - Recommendation: YES - DIP is nice-to-have, not critical
   - Rationale: Current architecture is solid, DIP improves testability but doesn't block ship

2. **Should we rename the catalog.json file back to registry.json?**
   - Recommendation: NO - Keep catalog.json as decided
   - Rationale: Catalog is more accurate term, rename is already mostly done

3. **Should we prioritize DIP Phase 3-4 or new features?**
   - Recommendation: Evaluate after v2.0 ship based on priorities
   - Rationale: DIP is important but new features may provide more user value

### Assumptions

1. Old registry files are safe to delete (verified by STATUS report)
2. Parameter rename has no breaking changes for users (internal API only)
3. Current test suite accurately reflects requirements
4. DIP implementation can be done incrementally without blocking ship

---

**END OF IMPLEMENTATION PLAN**

Generated: 2025-11-16 07:02:37
Source: STATUS-2025-11-16-070000.md + DIP_AUDIT-2025-11-07-010149.md
Total Work Identified: 13 items across 4 priority levels
Critical Path: 30 minutes (3 items)
Ship Timeline: This week (after 3 hours total work)
