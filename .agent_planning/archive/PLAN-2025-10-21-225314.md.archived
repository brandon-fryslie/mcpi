# MCPI Foundation Repair and Rescope Feature Implementation Plan

**Source**: STATUS-2025-10-21-225033.md (40% completion, critical foundation issues)
**Spec Version**: CLAUDE.md (MCPI MCP manager architecture)
**Feature Spec**: .agent_planning/BACKLOG.md (rescope feature)
**Generated**: 2025-10-21 22:53:14

---

## Executive Summary

The MCPI project is currently at **40% completion** with **critical foundation instability** that blocks new feature development. The recent STATUS evaluation revealed harsh realities:

- **19 of 62 test files fail to import** (31% of test suite broken)
- **171+ references to deleted modules** (massive technical debt)
- **Missing critical API methods** required for rescope feature
- **Unverified functionality claims** due to broken test infrastructure

The user has requested implementation of the **rescope feature** from BACKLOG.md, which allows moving MCP server configurations between scopes (e.g., project → user). However, the STATUS report makes clear: **prerequisites must be fixed first**.

This plan provides a **TWO-PHASE approach**:

1. **Phase 1: Foundation Repair** (3-4 days) - Fix broken tests, implement missing APIs, clean technical debt
2. **Phase 2: Rescope Feature** (2-3 days) - Implement the actual rescope functionality on stable foundation

**Total Timeline**: 5-7 days to completed, tested rescope feature

**Current Blockers for Rescope**:
1. Missing `ScopeHandler.get_server_config()` method (CRITICAL - rescope cannot work without it)
2. 19 test files cannot import (CRITICAL - cannot validate implementation)
3. Incompatible API between tests and implementation (HIGH - test/code mismatch)
4. 171+ broken module references (MEDIUM - navigational confusion)

---

## PHASE 1: FOUNDATION REPAIR (Prerequisites for Rescope)

**Goal**: Stabilize the foundation to enable safe feature development
**Timeline**: 3-4 days
**Success Criteria**: All tests import and run, missing APIs implemented, critical debt cleaned

---

### P0-1: Fix Test Import Failures (19 broken test files)

**Status**: Not Started
**Effort**: Large (1-2 weeks)
**Dependencies**: None
**Spec Reference**: CLAUDE.md Testing Strategy • **Status Reference**: STATUS-2025-10-21-225033.md "BRUTAL TRUTH: TEST EXECUTION RESULTS"

#### Description

31% of the test suite (19 of 62 files) cannot import due to deleted modules and API breaking changes. This is BLOCKING all validation work. Tests expect modules and classes that no longer exist:

**Deleted Modules Causing Import Failures**:
- `mcpi.registry.manager` (deleted, 2 tests fail)
- `mcpi.registry.doc_parser` (deleted, 2 tests fail)
- `ServerInstallation` class (removed, 6+ installer tests fail)
- `get_method_string` function (removed, CLI tests fail)
- `Platform` enum (possibly moved/renamed, installer tests fail)

**Evidence from STATUS**:
```bash
ERROR tests/functional/test_end_to_end_workflows.py
  ModuleNotFoundError: No module named 'mcpi.registry.manager'

ERROR tests/functional/test_installation_workflows.py
  ImportError: cannot import name 'ServerInstallation'

ERROR tests/test_cli_comprehensive.py
  ImportError: cannot import name 'get_method_string'

ERROR tests/test_installer_claude_code.py
  ImportError: cannot import name 'ServerInstallation'

ERROR tests/test_registry.py
  ModuleNotFoundError: No module named 'mcpi.registry.doc_parser'

ERROR tests/test_registry_manager.py
  ModuleNotFoundError: No module named 'mcpi.registry.manager'
```

**Broken Test Files** (from STATUS):
1. `tests/functional/test_end_to_end_workflows.py`
2. `tests/functional/test_installation_workflows.py`
3. `tests/test_cli_comprehensive.py`
4. `tests/test_installer_claude_code.py`
5. `tests/test_installer_npm.py`
6. `tests/test_installer_python.py`
7. `tests/test_installer_git.py`
8. `tests/test_registry.py`
9. `tests/test_registry_manager.py`
10. `tests/test_config_manager.py`
11. `tests/test_config_profiles.py`
12. `tests/test_config_templates.py`
13. `tests/test_discovery.py`
14. `tests/test_validation.py`
15. `tests/test_cli_config.py`
16. `tests/test_cli_install.py`
17. `tests/test_cli_search.py`
18. `tests/test_cli_status.py`
19. `tests/test_plugin_system.py`

#### Acceptance Criteria

- [ ] All 19 test files can import successfully (0 import errors)
- [ ] Align test imports with current implementation API
- [ ] Replace references to deleted modules with current equivalents or delete obsolete tests
- [ ] Document API changes that affected tests (what was removed, what replaced it)
- [ ] Run `pytest tests/ --collect-only` succeeds for all test files
- [ ] Verify at least 80% of tests can execute (may fail assertions, but must run)
- [ ] Update test fixtures/mocks to match current data models

#### Technical Notes

**Strategy**:
1. First, categorize broken tests:
   - **Obsolete**: Tests for deleted functionality → DELETE
   - **Outdated**: Tests for functionality that still exists but API changed → UPDATE
   - **Missing**: Tests for functionality that should exist but doesn't → IMPLEMENT THEN TEST

2. For each broken import:
   - Search codebase for what replaced it
   - Update import statements
   - Update test mocks/fixtures to new API
   - If no replacement exists, decide: delete test or implement missing functionality

3. Focus areas:
   - Registry tests: `manager.py` and `doc_parser.py` were deleted. Does functionality still exist elsewhere?
   - Installer tests: `ServerInstallation` was removed. What data model replaced it?
   - CLI tests: `get_method_string` removed. What replaced it?

**Files to Review**:
- `/Users/bmf/icode/mcpi/src/mcpi/registry/` - what modules still exist?
- `/Users/bmf/icode/mcpi/src/mcpi/clients/` - current plugin architecture
- `/Users/bmf/icode/mcpi/src/mcpi/installer/` - current installer API

---

### P0-2: Implement Missing `ScopeHandler.get_server_config()` API

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: None (independent of P0-1)
**Spec Reference**: CLAUDE.md Plugin Architecture • **Status Reference**: STATUS-2025-10-21-225033.md "SPECIFICATION COMPLIANCE MATRIX" line 98-118

#### Description

The rescope feature REQUIRES `ScopeHandler.get_server_config(server_id: str) -> ServerConfig` method, but it **DOES NOT EXIST** in the base class. This is a CRITICAL blocker - rescope cannot be implemented without it.

**Evidence from STATUS**:
```python
# BACKLOG.md requires:
def get_server_config(self, server_id: str) -> ServerConfig:
    """Returns the full configuration for a specific server"""

# base.py ScopeHandler has:
- exists()
- get_servers()
- add_server()
- remove_server()
- update_server()
- has_server()

# MISSING: get_server_config()
```

**Current State**:
- File: `/Users/bmf/icode/mcpi/src/mcpi/clients/base.py` (lines 1-313)
- Class: `ScopeHandler` (abstract base class)
- Missing method: `get_server_config(server_id: str)`

**Required for**: Rescope feature needs to read full server configuration from source scope before copying to destination scope.

#### Acceptance Criteria

- [ ] Add `get_server_config(server_id: str) -> ServerConfig` to `ScopeHandler` abstract base class
- [ ] Implement method in `FileBasedScope` class (concrete implementation)
- [ ] Method returns full `ServerConfig` object for a given server ID
- [ ] Raises appropriate error if server doesn't exist in scope
- [ ] Write unit tests for new method (test both base contract and FileBasedScope implementation)
- [ ] Verify method integrates with existing `has_server()` and `get_servers()` methods
- [ ] Update any documentation/docstrings to describe the new method

#### Technical Notes

**Implementation Location**:
- Add abstract method to `ScopeHandler` in `/Users/bmf/icode/mcpi/src/mcpi/clients/base.py`
- Implement in `FileBasedScope` class (likely same file or nearby)

**Expected Behavior**:
```python
# Usage pattern for rescope
source_handler = client_plugin.get_scope_handler(from_scope)
server_config = source_handler.get_server_config(server_name)  # ← This method

# Then use server_config to add to destination:
dest_handler = client_plugin.get_scope_handler(to_scope)
dest_handler.add_server(server_name, server_config)
```

**Testing Requirements**:
- Test success path: server exists → returns ServerConfig
- Test error path: server doesn't exist → raises clear error
- Test data integrity: returned config matches what's in scope file
- Test edge cases: empty scopes, malformed configs, etc.

---

### P0-3: Clean Critical Technical Debt (171+ broken references)

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: None (can run in parallel with P0-1, P0-2)
**Spec Reference**: N/A (cleanup task) • **Status Reference**: STATUS-2025-10-21-225033.md "RISK FACTORS" line 249-253

#### Description

The codebase contains **171+ references to deleted modules** (primarily `ClaudeCodeInstaller`), making it difficult to navigate and distinguish active code from legacy code. This technical debt creates confusion and risk during feature development.

**Evidence from STATUS**: "171+ references to deleted `ClaudeCodeInstaller`" - unclear which code is active vs. legacy.

**Likely Sources of Broken References**:
- Old installer imports (e.g., `from mcpi.installer import ClaudeCodeInstaller`)
- Deprecated test fixtures/mocks
- Commented-out code that references deleted classes
- Documentation examples using old API
- Type hints referencing deleted types

#### Acceptance Criteria

- [ ] Search entire codebase for references to deleted modules/classes
- [ ] Categorize each reference: delete, update, or document as intentional
- [ ] Remove or update all broken references (target: 0 remaining)
- [ ] Clean up dead code files (e.g., `cli_old.py`, `cli_optimized.py` if they exist)
- [ ] Update any lingering documentation to current API
- [ ] Verify no import errors for deleted modules remain
- [ ] Run linter/type checker to catch remaining issues

#### Technical Notes

**Search Strategy**:
```bash
# Find all references to known-deleted modules
grep -r "ClaudeCodeInstaller" src/ tests/
grep -r "registry.manager" src/ tests/
grep -r "registry.doc_parser" src/ tests/
grep -r "ServerInstallation" src/ tests/
grep -r "get_method_string" src/ tests/
```

**Decision Framework**:
- If reference is in a test: update to new API or delete obsolete test
- If reference is in active code: update to new API (should be rare if tests caught it)
- If reference is in comments/docs: update or delete
- If reference is in dead files: delete the entire file (after confirming it's unused)

**Risk Mitigation**: Run full test suite after cleanup to ensure nothing broke.

---

### P0-4: Validate Core Functionality

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: P0-1 (need working tests)
**Spec Reference**: CLAUDE.md CLI Interface • **Status Reference**: STATUS-2025-10-21-225033.md "CLI Execution Results" line 61-76

#### Description

The STATUS report shows basic CLI commands work manually, but cannot verify functionality without working tests. Once test infrastructure is fixed, validate that claimed features actually work.

**What STATUS Confirmed Works**:
```bash
✓ python -m mcpi.cli --help                  # Shows command structure
✓ python -m mcpi.cli list                    # Lists 3 servers
✓ python -m mcpi.cli client list             # Shows 1 client (claude-code)
✓ python -m mcpi.cli scope list              # Shows 6 scopes
✓ python -m mcpi.cli registry list           # Shows ~12 registry entries
```

**What Cannot Be Verified** (needs working tests):
- Add/remove operations
- Enable/disable functionality
- Error handling
- Edge cases
- Installation workflows

#### Acceptance Criteria

- [ ] Run full test suite successfully (pytest tests/ passes with >80% tests passing)
- [ ] Verify all manually-tested commands have automated test coverage
- [ ] Test add/remove operations in isolated test environment
- [ ] Test enable/disable functionality
- [ ] Verify error handling for invalid inputs
- [ ] Run smoke tests for installation workflows
- [ ] Measure actual test coverage (not inflated by broken tests)
- [ ] Document any gaps between claimed functionality and actual behavior

#### Technical Notes

**Validation Strategy**:
1. After P0-1 fixes test imports, run full suite: `pytest tests/ -v`
2. Review coverage report: `pytest --cov=src/mcpi --cov-report=html`
3. Manually test any untested CLI commands
4. Compare STATUS claims against test results
5. Update documentation if functionality differs from claims

**Success Metric**: Can confidently state "X% of functionality is tested and working" with evidence.

---

## PHASE 1 SUMMARY

**Prerequisites Completion Checklist**:
- [ ] P0-1: All 19 test files can import and run (19 import errors → 0 import errors)
- [ ] P0-2: `ScopeHandler.get_server_config()` method exists and works
- [ ] P0-3: Technical debt cleaned (171+ broken references → <10 acceptable references)
- [ ] P0-4: Core functionality validated with working test suite

**Phase 1 Timeline**: 3-4 days (can parallelize P0-2 and P0-3 while working on P0-1)

**Phase 1 Success Criteria**:
- Test suite runs successfully (`pytest tests/` completes without import errors)
- Core CLI commands have automated test coverage
- Required API methods implemented for rescope feature
- Codebase is navigable without confusion from dead code

**ONLY AFTER Phase 1 completion → Proceed to Phase 2**

---

## PHASE 2: RESCOPE FEATURE IMPLEMENTATION

**Goal**: Implement the rescope feature from BACKLOG.md
**Timeline**: 2-3 days
**Prerequisites**: Phase 1 complete (stable foundation)

---

### P1-1: Implement Core Rescope Logic

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: P0-1, P0-2, P0-4 (need working tests, get_server_config API, validated core)
**Spec Reference**: .agent_planning/BACKLOG.md lines 44-109 • **Status Reference**: STATUS-2025-10-21-225033.md "BACKLOG.md RESCOPE SPECIFICATION ANALYSIS" line 261-298

#### Description

Implement the core rescope operation that moves a server configuration from one scope to another within the same client. This is a transactional operation with rollback on failure.

**Required Functionality** (from BACKLOG.md):
1. Read server config from source scope
2. Validate source server exists, destination does not
3. Write config to destination scope
4. Remove from source scope (with rollback if this fails)
5. Support dry-run mode

**Technical Design** (from BACKLOG.md line 61-109):
```python
def rescope_server(server_name, from_scope, to_scope, client=None, dry_run=False):
    # 1. Get the client plugin
    manager = get_mcp_manager()
    client_plugin = manager.get_client(client)

    # 2. Validate scopes exist for this client
    validate_scope(client_plugin, from_scope)
    validate_scope(client_plugin, to_scope)

    # 3. Get source scope handler
    source_handler = client_plugin.get_scope_handler(from_scope)
    if not source_handler.has_server(server_name):
        raise ServerNotFoundError(...)

    # 4. Get destination scope handler
    dest_handler = client_plugin.get_scope_handler(to_scope)
    if dest_handler.has_server(server_name):
        raise ServerExistsError(...)

    # 5. Read config from source
    server_config = source_handler.get_server_config(server_name)  # ← Uses P0-2 API

    # 6. If dry-run, show what would happen and exit
    if dry_run:
        print_dry_run_summary(...)
        return

    # 7. Write to destination
    result = dest_handler.add_server(server_name, server_config)
    if not result.success:
        raise WriteError(...)

    # 8. Remove from source (with rollback on failure)
    try:
        result = source_handler.remove_server(server_name)
        if not result.success:
            # Rollback: remove from destination
            dest_handler.remove_server(server_name)
            raise RemoveError(...)
    except Exception as e:
        # Rollback: remove from destination
        dest_handler.remove_server(server_name)
        raise

    # 9. Return success
    return OperationResult.success(...)
```

#### Acceptance Criteria

- [ ] Implement `rescope_server()` function or `MCPManager.rescope_server()` method
- [ ] Function validates scopes against selected client's available scopes
- [ ] Function checks source server exists before proceeding
- [ ] Function checks destination server doesn't exist before proceeding
- [ ] Function reads full server config from source using `get_server_config()`
- [ ] Function writes config to destination using `add_server()`
- [ ] Function removes from source using `remove_server()`
- [ ] Rollback implemented: if remove fails, delete from destination
- [ ] Dry-run mode shows what would happen without making changes
- [ ] All error cases have clear, actionable error messages
- [ ] Function returns success/failure result object

#### Technical Notes

**Implementation Location**: Either:
- New method in `MCPManager` class (`src/mcpi/clients/manager.py`)
- OR standalone function in new module (`src/mcpi/operations/rescope.py`)

**Testing Requirements** (defer to P1-2, but plan for):
- Unit tests for validation logic
- Unit tests for rollback mechanism
- Integration tests for full rescope workflow

---

### P1-2: Implement Rescope CLI Command

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: P1-1 (need core rescope logic)
**Spec Reference**: .agent_planning/BACKLOG.md lines 111-135 • **Status Reference**: STATUS-2025-10-21-225033.md line 138

#### Description

Add `mcpi rescope` command to the CLI with support for position-independent arguments and integration with the existing plugin system.

**Command Syntax** (from BACKLOG.md):
```bash
# Standard syntax
mcpi rescope <server_name> --from <source_scope> --to <dest_scope>

# Position-independent variations (all should work)
mcpi rescope my-server --from project-mcp --to user-internal
mcpi rescope --from project-mcp --to user-internal my-server
mcpi rescope --from project-mcp my-server --to user-internal
mcpi rescope --to user-internal --from project-mcp my-server

# With client specification
mcpi rescope my-server --from project-mcp --to user-internal --client claude-code

# Dry-run mode
mcpi rescope my-server --from project-mcp --to user-internal --dry-run
```

**CLI Implementation** (from BACKLOG.md):
```python
@main.command()
@click.argument('server_name')
@click.option('--from', 'from_scope', required=True,
              type=DynamicScopeType(),  # Reuse existing validation
              help='Source scope to move from')
@click.option('--to', 'to_scope', required=True,
              type=DynamicScopeType(),
              help='Destination scope to move to')
@click.option('--client', default=None,
              help='MCP client to use (auto-detected if not specified)')
@click.option('--dry-run', is_flag=True,
              help='Show what would happen without making changes')
@click.pass_context
def rescope(ctx, server_name, from_scope, to_scope, client, dry_run):
    """Move an MCP server configuration from one scope to another."""
    # Implementation calls P1-1 logic
```

#### Acceptance Criteria

- [ ] Add `rescope` command to `src/mcpi/cli.py`
- [ ] Command accepts `server_name` as argument
- [ ] Command accepts `--from` and `--to` options (required)
- [ ] Command accepts `--client` option (optional, auto-detect if not provided)
- [ ] Command accepts `--dry-run` flag
- [ ] Command uses existing `DynamicScopeType` for scope validation (reuse code at cli.py:112-198)
- [ ] Command integrates with `MCPManager` for client detection
- [ ] Command calls P1-1 rescope logic
- [ ] Command displays success/failure message with Rich formatting
- [ ] Command help text includes examples
- [ ] `mcpi --help` lists rescope command

#### Technical Notes

**Integration Points**:
- Reuse `DynamicScopeType` from existing CLI (STATUS confirms exists at cli.py:112-198)
- Use same client detection pattern as other commands (check existing commands for pattern)
- Follow existing error handling patterns in CLI

**User Experience**:
- Success message should clearly state what happened: "Server 'X' moved from 'Y' to 'Z'"
- Error messages should suggest next steps (e.g., "Server not found in scope. Use `mcpi list --scope X` to see available servers")
- Dry-run output should show before/after state

---

### P1-3: Comprehensive Rescope Testing

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: P1-1, P1-2 (need implementation complete)
**Spec Reference**: .agent_planning/BACKLOG.md lines 177-237 • **Status Reference**: STATUS-2025-10-21-225033.md "Test Requirements from BACKLOG.md" line 290-296

#### Description

Create comprehensive test suite for rescope feature covering unit tests, integration tests, and functional tests. Target: 95%+ coverage of rescope code.

**Test Requirements from BACKLOG.md**:
- Unit tests for rescope command
- Integration tests for full workflows
- Functional tests with real config files
- Target: 95%+ coverage

**Test Files to Create**:
1. `tests/test_cli_rescope.py` - Unit tests for CLI command
2. `tests/test_rescope_integration.py` - Integration tests for full workflows
3. `tests/test_rescope_functional.py` - Functional tests with real files

#### Acceptance Criteria

**Unit Tests** (`tests/test_cli_rescope.py`):
- [ ] Test basic rescope flow (server exists in source, doesn't exist in dest, rescope succeeds)
- [ ] Test position-independent arguments (all variations from BACKLOG.md)
- [ ] Test error: server not in source scope
- [ ] Test error: server already exists in destination scope
- [ ] Test error: invalid source scope name
- [ ] Test error: invalid destination scope name
- [ ] Test error: source and destination are the same scope
- [ ] Test dry-run mode (no changes made to files)
- [ ] Test rollback on remove failure (destination cleaned up)
- [ ] Test with explicit `--client` flag
- [ ] Test multi-client scope validation

**Integration Tests** (`tests/test_rescope_integration.py`):
- [ ] Test full rescope workflow from project to user scope
- [ ] Test full rescope workflow from user to project scope
- [ ] Test that all configuration fields are preserved during rescope
- [ ] Test that source file loses server after rescope
- [ ] Test that destination file gains server after rescope
- [ ] Test rescope with complex server configurations

**Functional Tests** (`tests/test_rescope_functional.py`):
- [ ] Test with actual `.mcp.json` files (not mocked)
- [ ] Test with actual `settings.json` files (not mocked)
- [ ] Test cross-scope rescope in real filesystem (temporary directories)
- [ ] Test error recovery in real scenarios

**Coverage Target**:
- [ ] Rescope core logic: >95% coverage
- [ ] Rescope CLI command: >95% coverage
- [ ] Overall feature: >95% coverage

#### Technical Notes

**Testing Strategy**:
1. Unit tests focus on validation and error handling
2. Integration tests focus on data flow and state changes
3. Functional tests focus on real filesystem operations

**Test Fixtures Needed**:
- Mock server configurations with various complexity levels
- Temporary scope files (both source and destination)
- Mock `MCPManager` and `ScopeHandler` for unit tests
- Real temporary directories for functional tests

**Validation**:
- After rescope, source scope file should NOT contain server
- After rescope, destination scope file SHOULD contain server with identical config
- Failed rescope should leave both scopes unchanged (rollback works)
- Dry-run should never modify files

---

### P1-4: Documentation and Finalization

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: P1-1, P1-2, P1-3 (need implementation and tests complete)
**Spec Reference**: .agent_planning/BACKLOG.md lines 270-281 • **Status Reference**: N/A

#### Description

Update documentation to reflect the new rescope feature, add examples to README, update CHANGELOG, and ensure feature is fully documented.

**Documentation Tasks from BACKLOG.md**:
- Update CLI help documentation (done in P1-2)
- Add examples to README.md
- Add entry to CHANGELOG.md

#### Acceptance Criteria

- [ ] Add rescope section to README.md with examples
- [ ] Add rescope examples showing common workflows:
  - Moving from project to user scope
  - Moving from user to project scope
  - Using dry-run mode
  - Error scenarios and troubleshooting
- [ ] Add entry to CHANGELOG.md describing new feature
- [ ] Update any architecture documentation if rescope logic added new components
- [ ] Verify `mcpi rescope --help` shows comprehensive help text
- [ ] Add rescope to feature list in README if one exists
- [ ] Update any diagrams if they show scope operations

#### Technical Notes

**README Examples to Add**:
```bash
# Example: Test a server at project level, then promote to user level
mcpi rescope my-server --from project-mcp --to user-internal

# Example: Use dry-run to preview changes
mcpi rescope my-server --from project-mcp --to user-internal --dry-run

# Example: Move server back to project level for customization
mcpi rescope my-server --from user-internal --to project-mcp
```

**CHANGELOG Entry**:
```markdown
## [Unreleased]

### Added
- `rescope` command to move MCP server configurations between scopes
  - Supports position-independent arguments
  - Includes dry-run mode for previewing changes
  - Implements transactional rollback on failure
  - 95%+ test coverage
```

---

## PHASE 2 SUMMARY

**Rescope Feature Completion Checklist**:
- [ ] P1-1: Core rescope logic implemented with rollback
- [ ] P1-2: CLI command added and integrated
- [ ] P1-3: Comprehensive test suite (95%+ coverage)
- [ ] P1-4: Documentation updated with examples

**Phase 2 Timeline**: 2-3 days

**Phase 2 Success Criteria**:
- `mcpi rescope` command works for all documented use cases
- All error scenarios handled gracefully with clear messages
- 95%+ test coverage with passing tests
- Feature documented in README and CHANGELOG
- Users can successfully move servers between scopes

---

## OVERALL PROJECT TIMELINE

### Phase 1: Foundation Repair
**Duration**: 3-4 days
**Work Items**: P0-1, P0-2, P0-3, P0-4
**Parallelization**: P0-2 and P0-3 can run in parallel with P0-1

**Week 1 Schedule**:
- Days 1-2: P0-1 (Fix test imports) + P0-2 (Implement get_server_config) in parallel
- Days 2-3: P0-3 (Clean technical debt) + continue P0-1 if needed
- Day 4: P0-4 (Validate core functionality)

### Phase 2: Rescope Implementation
**Duration**: 2-3 days
**Work Items**: P1-1, P1-2, P1-3, P1-4
**Parallelization**: P1-1 and P1-2 can partially overlap (implement CLI while testing core logic)

**Week 2 Schedule**:
- Day 1: P1-1 (Core rescope logic)
- Day 2: P1-2 (CLI command) + start P1-3 (testing)
- Day 3: Complete P1-3 (testing) + P1-4 (documentation)

### Total Project Timeline
**Estimated Duration**: 5-7 days
**Best Case**: 5 days (if parallelization works well, no major surprises)
**Realistic Case**: 6 days (some integration issues, normal debugging)
**Worst Case**: 7 days (major architectural issues discovered, extensive refactoring needed)

---

## DEPENDENCY GRAPH

```
PHASE 1 (Foundation)
┌─────────────────────────────────────────────────────────┐
│ P0-1: Fix Test Imports (19 files)                      │
│   ↓                                                     │
│ P0-4: Validate Core Functionality                      │
└─────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────┐
│ P0-2: Implement get_server_config() [Independent]      │
└─────────────────────────────────────────────────────────┘
        ↓
┌─────────────────────────────────────────────────────────┐
│ P0-3: Clean Technical Debt [Independent]               │
└─────────────────────────────────────────────────────────┘
        ↓
PHASE 2 (Rescope)
┌─────────────────────────────────────────────────────────┐
│ P1-1: Core Rescope Logic                               │
│   ↓                                                     │
│ P1-2: CLI Command                                       │
│   ↓                                                     │
│ P1-3: Comprehensive Testing                            │
│   ↓                                                     │
│ P1-4: Documentation                                     │
└─────────────────────────────────────────────────────────┘
```

**Critical Path**: P0-1 → P0-4 → P1-1 → P1-2 → P1-3 → P1-4
**Parallelizable**: P0-2, P0-3 can run alongside P0-1

---

## RISK ASSESSMENT

### HIGH RISK - Test Import Fixes May Reveal Deeper Issues

**Risk**: Fixing 19 test import errors may reveal that large portions of the test suite are obsolete or that significant functionality was deleted without replacement.

**Impact**: HIGH - Could extend Phase 1 timeline by 2-3 days

**Mitigation**:
- Start with categorization: obsolete vs. outdated tests
- Delete obsolete tests quickly rather than trying to fix them
- Focus on tests for core functionality first (CLI, registry, plugin system)
- Defer less critical test fixes to post-rescope work

**Contingency**: If >50% of tests are obsolete, reassess testing strategy and focus on new tests for rescope feature rather than fixing old tests.

---

### MEDIUM RISK - Technical Debt Cleanup Uncovers Hidden Dependencies

**Risk**: The 171+ broken references may be more complex than simple find/replace. Some may indicate deeper architectural mismatches.

**Impact**: MEDIUM - Could extend Phase 1 timeline by 1-2 days

**Mitigation**:
- Start with automated search to identify all references
- Categorize by severity: blocking vs. cosmetic
- Focus on blocking issues (imports that fail) before cosmetic issues (comments)
- Use linter/type checker to verify cleanup doesn't break anything

**Contingency**: If cleanup reveals major issues, create separate tickets and defer non-blocking cleanup to post-rescope work.

---

### LOW RISK - Rescope Feature Complexity Underestimated

**Risk**: The rescope feature may have edge cases or complexity not captured in BACKLOG.md spec.

**Impact**: LOW - Spec is detailed and feature is well-scoped

**Mitigation**:
- BACKLOG.md provides detailed technical design (lines 61-109)
- Comprehensive error handling documented (lines 146-176)
- Testing requirements clear (lines 177-237)
- Phase 1 ensures stable foundation before starting

**Contingency**: If complexity discovered, can defer advanced features (batch rescope, force/merge flags) to future enhancements.

---

### LOW RISK - Foundation May Not Fully Stabilize

**Risk**: Phase 1 may fix immediate issues but uncover deeper instability requiring more work.

**Impact**: LOW - Manual testing confirms basic functionality works

**Mitigation**:
- STATUS shows CLI commands work manually, indicating core is sound
- Foundation issues are mostly test infrastructure, not implementation
- Can implement rescope with partial test coverage if needed

**Contingency**: If foundation remains unstable, implement rescope with extra caution and manual testing, then return to foundation work after rescope is complete.

---

## SUCCESS METRICS

### Phase 1 Success Criteria

**Test Infrastructure**:
- [ ] 0 test import errors (down from 19)
- [ ] >80% of test suite can execute
- [ ] pytest runs without crashing

**API Completeness**:
- [ ] `ScopeHandler.get_server_config()` exists and works
- [ ] Method tested with >90% coverage
- [ ] Method integrated with existing scope handlers

**Code Quality**:
- [ ] <10 broken references remaining (down from 171+)
- [ ] Linter passes without errors
- [ ] Type checker passes without errors

**Functional Validation**:
- [ ] Core CLI commands have automated test coverage
- [ ] Manual smoke tests pass
- [ ] Coverage measurement accurate (not inflated)

### Phase 2 Success Criteria

**Rescope Implementation**:
- [ ] `mcpi rescope` command exists and works
- [ ] All documented argument variations supported
- [ ] Dry-run mode works correctly
- [ ] Rollback mechanism tested and working

**Error Handling**:
- [ ] All 7 error cases from BACKLOG.md handled gracefully
- [ ] Error messages clear and actionable
- [ ] No silent failures or data corruption

**Testing**:
- [ ] 95%+ test coverage for rescope feature
- [ ] All unit tests pass
- [ ] All integration tests pass
- [ ] All functional tests pass

**Documentation**:
- [ ] README updated with examples
- [ ] CHANGELOG updated
- [ ] CLI help comprehensive
- [ ] Feature discoverable by users

### Overall Project Success

**Completion Criteria**:
- [ ] User can successfully move servers between scopes using `mcpi rescope`
- [ ] Feature works for all documented use cases
- [ ] Test suite validates feature correctness
- [ ] Foundation stable enough for future feature development
- [ ] Project moves from 40% → 60%+ completion (foundation + rescope)

**Quality Gates**:
- [ ] No failing tests in core modules
- [ ] No broken imports in test suite
- [ ] Code is navigable without confusion from dead code
- [ ] Documentation accurately reflects implementation
- [ ] Feature meets all acceptance criteria from BACKLOG.md

---

## RETROSPECTIVE: What We Learned from STATUS Report

### What Previous Assessment Got Wrong

**Previous Report** (STATUS-2025-10-16-232845.md): "75% completion, production ready"
**Reality**: 40% completion, foundation broken

**Key Lessons**:
1. **Run the tests**: Manual testing is not enough. Previous assessment didn't run pytest.
2. **Verify claims**: "Production ready" requires evidence, not assumptions.
3. **Import errors are canaries**: 19 import errors indicated deeper architectural mismatch.
4. **Test coverage can lie**: Coverage report without running tests is meaningless.

### What This Assessment Does Differently

1. **Evidence-based**: All claims backed by actual test execution results
2. **Realistic timelines**: Acknowledges prerequisites before feature work
3. **Phased approach**: Fix foundation first, then build features
4. **Risk awareness**: Identifies high-risk areas and mitigation strategies
5. **Clear success criteria**: Measurable, testable criteria for each phase

### Commitment to Realistic Planning

This plan is **conservative and realistic**:
- Timeline accounts for debugging and unforeseen issues
- Prerequisites identified before feature work
- Risk assessment acknowledges what could go wrong
- Success metrics are measurable and objective

**Goal**: Deliver a working, tested rescope feature on a stable foundation, not rush to "completion" with broken tests.

---

## BLOCKERS AND QUESTIONS

### Current Blockers

1. **RESOLVED by this plan**: Previous optimistic assessment blocked progress by hiding real issues
2. **RESOLVED by Phase 1**: Missing API methods block rescope implementation → P0-2 addresses this
3. **RESOLVED by Phase 1**: Broken test infrastructure blocks validation → P0-1 addresses this

### Outstanding Questions

1. **Test Obsolescence**: What percentage of broken tests are obsolete vs. outdated?
   - **Resolution**: Will be answered during P0-1 categorization phase
   - **Impact**: May reduce Phase 1 timeline if many tests can be deleted

2. **Architecture Mismatch**: Why were `registry.manager` and `registry.doc_parser` deleted?
   - **Resolution**: Will be answered during P0-1 code review
   - **Impact**: May inform whether to restore modules or update dependent code

3. **Installation Workflows**: Do installation workflows actually work end-to-end?
   - **Resolution**: Will be answered during P0-4 validation phase
   - **Impact**: May reveal additional work needed beyond rescope feature

### Clarifications Needed from User

- **None**: Plan is based on clear directives from STATUS report and BACKLOG.md spec
- **Decision authority**: If >50% of tests are obsolete, should we delete them or fix them?
- **Priority**: If foundation work takes longer than estimated, should we continue foundation work or implement rescope with partial foundation?

---

## APPENDIX: File References

### Key Files to Modify

**Phase 1**:
- `/Users/bmf/icode/mcpi/src/mcpi/clients/base.py` - Add `get_server_config()` method
- `/Users/bmf/icode/mcpi/tests/test_*.py` - Fix 19 broken test files (see P0-1 for list)
- Various files - Clean 171+ broken references (see P0-3)

**Phase 2**:
- `/Users/bmf/icode/mcpi/src/mcpi/cli.py` - Add `rescope` command
- `/Users/bmf/icode/mcpi/src/mcpi/clients/manager.py` or new file - Implement rescope logic
- `/Users/bmf/icode/mcpi/tests/test_cli_rescope.py` - New unit tests
- `/Users/bmf/icode/mcpi/tests/test_rescope_integration.py` - New integration tests
- `/Users/bmf/icode/mcpi/tests/test_rescope_functional.py` - New functional tests
- `/Users/bmf/icode/mcpi/README.md` - Add rescope documentation
- `/Users/bmf/icode/mcpi/CHANGELOG.md` - Add rescope entry

### Key Files for Reference

- `/Users/bmf/icode/mcpi/STATUS-2025-10-21-225033.md` - Current state assessment
- `/Users/bmf/icode/mcpi/.agent_planning/BACKLOG.md` - Rescope feature specification
- `/Users/bmf/icode/mcpi/CLAUDE.md` - Project architecture and commands
- `/Users/bmf/icode/mcpi/src/mcpi/cli.py:112-198` - Existing `DynamicScopeType` validation

---

**END OF PLAN**

**Next Steps**:
1. Review this plan for accuracy and completeness
2. Begin Phase 1, P0-1: Fix test import failures
3. Update plan if major discoveries during P0-1 require course correction
4. Do NOT start Phase 2 until Phase 1 success criteria met
