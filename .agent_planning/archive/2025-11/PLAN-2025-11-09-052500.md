# MCPI Project Plan - Design Patterns MCP Server Fix

**Generated**: 2025-11-09 05:25:00
**Source STATUS**: STATUS-2025-11-07-051344.md
**Source Evaluation**: EVALUATION-DESIGN-PATTERNS-MCP-2025-11-09.md
**Spec Reference**: CLAUDE.md
**Target**: Fix design-patterns MCP server connection + Add env var support to MCPI

---

## Provenance

**Input Documents**:
- **STATUS File**: STATUS-2025-11-07-051344.md (2025-11-07 05:13:44)
- **Evaluation File**: EVALUATION-DESIGN-PATTERNS-MCP-2025-11-09.md (2025-11-09)
- **Spec**: CLAUDE.md (last modified: 2025-11-07)
- **Generation Time**: 2025-11-09 05:25:00

**Authority**: This plan supersedes any conflicting planning artifacts. The latest STATUS file is the single source of truth for current MCPI state.

---

## Executive Summary

**Problem**: The design-patterns MCP server fails to connect when started by Claude Code due to missing `PATTERNS_DIR` environment variable in the configuration.

**Root Cause**: The server requires an absolute path to its corpus directory, but Claude Code configuration lacks the required environment variable, causing the server to fail on startup with relative path resolution.

**Solution Split**:
1. **IMMEDIATE (P0)**: Manual configuration fix in `~/.claude.json` to make the server work now
2. **FUTURE (P1)**: Add environment variable support to MCPI registry schema to prevent this issue for all future server installations

**Scope**:
- This plan addresses BOTH the immediate fix AND the MCPI enhancement
- P0 work is outside MCPI (manual config edit)
- P1 work is inside MCPI (feature addition)

**Current State** (from STATUS-2025-11-07-051344.md):
- MCPI: 93% complete, production-ready, ready to ship v2.0
- Test Pass Rate: 92% (589/640)
- All 13 CLI commands functional
- Zero blockers for MCPI itself

**Gap** (from EVALUATION-DESIGN-PATTERNS-MCP-2025-11-09.md):
- design-patterns server: Cannot connect (missing env var)
- MCPI registry: No support for environment variables in schema
- User impact: Server completely non-functional until fixed

---

## P0 (CRITICAL) - Immediate Fix (Outside MCPI)

### P0-1: Update Claude Code Configuration with PATTERNS_DIR

**Status**: Not Started
**Effort**: Trivial (2 minutes)
**Dependencies**: None
**Spec Reference**: N/A (Configuration fix, not MCPI code)
**Status Reference**: EVALUATION-DESIGN-PATTERNS-MCP-2025-11-09.md § Recommended Fixes (lines 215-255)

#### Description

The design-patterns MCP server is installed but cannot connect because the Claude Code configuration is missing the required `PATTERNS_DIR` environment variable. The server defaults to a relative path `./corpus` which fails when Claude Code starts the process from its own working directory.

**Evidence from Evaluation**:
- Manual test from correct directory: ✅ Works
- Manual test from wrong directory: ❌ Fails with "Patterns directory not found"
- Manual test with env var set: ✅ Works from any directory
- Claude Code test: ❌ "Failed to connect"

**Root Cause Chain**:
1. Claude Code starts: `node /Users/bmf/icode/design-pattern-mcp/dist/server.js`
2. Working directory: Claude's install dir (not server dir)
3. PATTERNS_DIR not set → Falls back to `./corpus`
4. Relative path fails → Index build fails → Server exits
5. Claude detects failure → "Failed to connect"

#### Acceptance Criteria

- [ ] Edit `~/.claude.json` to add PATTERNS_DIR environment variable
- [ ] Environment variable set to absolute path: `/Users/bmf/icode/design-pattern-mcp/corpus`
- [ ] Restart Claude Code or reload MCP servers
- [ ] Verify connection: `claude mcp list` shows "✓ Connected" for design-patterns
- [ ] Verify tools available: `claude mcp tools design-patterns` lists 6 tools
- [ ] No changes to MCPI codebase required

#### Technical Notes

**Current Configuration** (`~/.claude.json`):
```json
{
  "mcpServers": {
    "design-patterns": {
      "command": "node",
      "args": ["/Users/bmf/icode/design-pattern-mcp/dist/server.js"],
      "env": {},
      "type": "stdio"
    }
  }
}
```

**Required Configuration**:
```json
{
  "mcpServers": {
    "design-patterns": {
      "command": "node",
      "args": ["/Users/bmf/icode/design-pattern-mcp/dist/server.js"],
      "env": {
        "PATTERNS_DIR": "/Users/bmf/icode/design-pattern-mcp/corpus"
      },
      "type": "stdio"
    }
  }
}
```

**Testing**:
```bash
# After configuration update:
claude mcp list | grep design-patterns
# Expected: design-patterns: node ... - ✓ Connected

# Verify tools:
claude mcp tools design-patterns
# Expected: 6 tools listed (list_patterns, get_sections, get_section, compare, search, diagnostics)
```

**Why This is P0**:
- Server is completely non-functional without this fix
- User cannot access design pattern documentation
- Fix is trivial (single line in config file)
- Zero risk (read-only config update, easily reverted)
- No code changes required

**Important**: This work happens OUTSIDE the MCPI codebase. It is a manual configuration update in the user's Claude Code settings. This is documented here for completeness and to track the dependency for P1 work.

---

## P1 (HIGH) - MCPI Enhancement (Next 2 Weeks)

### P1-1: Add Environment Variable Support to MCPI Registry Schema

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: P0-1 (to validate design works)
**Spec Reference**: CLAUDE.md § Registry System (lines 246-250)
**Status Reference**: EVALUATION-DESIGN-PATTERNS-MCP-2025-11-09.md § Fix 2 (lines 258-284)

#### Description

Currently, MCPI's registry schema does not support environment variables in server entries. This means:
- Users installing servers that require env vars get incomplete configurations
- Servers fail on first run, requiring manual config editing
- No way to document required env vars in the registry
- Poor user experience for env-dependent servers

This feature adds first-class support for environment variables in the registry, enabling complete, working configurations on first install.

**Impact**:
- Future installations of design-patterns will work out-of-the-box
- All env-dependent servers can be properly documented
- Improves MCPI's value proposition (more servers "just work")
- Aligns with MCPI's goal of "universal installation"

#### Acceptance Criteria

**Schema Changes**:
- [ ] Add `env` field to `MCPServer` Pydantic model in `registry/catalog.py`
- [ ] Field type: `Optional[Dict[str, str]]` (maps env var name to value)
- [ ] Field default: `None` (backward compatible)
- [ ] Add validation: Env var names must be valid (alphanumeric + underscore)
- [ ] Update JSON schema to include `env` field (optional)
- [ ] Update CUE schema if applicable

**Registry Updates**:
- [ ] Update `data/registry.json` with design-patterns env var
- [ ] Add example entry showing env var usage
- [ ] Validate registry with updated schema (no errors)
- [ ] Update registry validation tests to handle env field

**Installation Logic**:
- [ ] Update `clients/claude_code.py` to include env vars in generated config
- [ ] Ensure env object written to config even if empty (for consistency)
- [ ] Update other client plugins (cursor, vscode) if applicable
- [ ] Handle env var interpolation (e.g., `$HOME`, absolute paths)

**Documentation**:
- [ ] Document env field in CLAUDE.md § Registry System
- [ ] Add example to README showing env var usage
- [ ] Update CHANGELOG with new feature
- [ ] Document env var best practices (absolute paths, security)

**Testing**:
- [ ] Unit test: MCPServer model accepts env field
- [ ] Unit test: MCPServer model validates env var names
- [ ] Integration test: Install server with env vars
- [ ] Integration test: Verify env vars in generated config
- [ ] Functional test: End-to-end install + verify server connects
- [ ] Regression test: Servers without env vars still work

#### Technical Notes

**Pydantic Model Update** (`src/mcpi/registry/catalog.py`):
```python
from typing import Optional, Dict

class MCPServer(BaseModel):
    """MCP server registry entry."""

    description: str
    command: str
    args: List[str]
    env: Optional[Dict[str, str]] = None  # NEW FIELD
    repository: Optional[str] = None
    # ... other fields
```

**Registry Entry Example** (`data/registry.json`):
```json
{
  "design-patterns": {
    "description": "Deterministic access to software design pattern documentation",
    "command": "node",
    "args": [
      "/Users/bmf/icode/design-pattern-mcp/dist/server.js"
    ],
    "env": {
      "PATTERNS_DIR": "/Users/bmf/icode/design-pattern-mcp/corpus"
    },
    "repository": "https://github.com/yourusername/design-pattern-mcp"
  }
}
```

**Installation Logic Update** (`src/mcpi/clients/claude_code.py`):
```python
def install_server(self, server_id: str, server: MCPServer) -> OperationResult:
    config = {
        "command": server.command,
        "args": server.args,
        "env": server.env or {},  # Use env from registry or empty dict
        "type": "stdio"
    }
    # ... rest of installation logic
```

**Challenges**:
1. **Path Interpolation**: Should env vars support `$HOME` or other interpolations?
   - **Recommendation**: Start simple (literal values only), add interpolation in v2.1

2. **Security**: Environment variables may contain sensitive data
   - **Recommendation**: Document that registry is public, avoid secrets in env

3. **User Overrides**: Should users be able to override registry env vars?
   - **Recommendation**: Phase 1 just uses registry values, add override support later

4. **Cross-Platform Paths**: Env vars with absolute paths may differ across OS
   - **Recommendation**: Document best practices, consider path templates in future

**Backward Compatibility**:
- Existing registry entries without `env` field: Continue working (default `None`)
- Existing installed servers: Unaffected (no re-installation required)
- Breaking change: **NONE** (purely additive feature)

**Testing Strategy**:
1. **Unit Tests**: Model validation, env var name validation
2. **Integration Tests**: Full install workflow with env vars
3. **Regression Tests**: Ensure servers without env vars still work
4. **Manual Verification**: Re-install design-patterns, verify connection

**Success Metrics**:
- [ ] `mcpi add design-patterns` creates working config (no manual edits)
- [ ] `claude mcp list` shows "✓ Connected" for design-patterns immediately
- [ ] All existing tests continue passing
- [ ] New tests validate env var functionality

---

## P2 (MEDIUM) - Optional Improvements (Next Month)

### P2-1: Add Path Interpolation for Environment Variables

**Status**: Not Started
**Effort**: Small (1-2 days)
**Dependencies**: P1-1 (env var support must exist)
**Spec Reference**: N/A (Future enhancement)
**Status Reference**: N/A (New feature suggestion)

#### Description

Enhance environment variable support to handle path interpolations like `$HOME`, `${HOME}`, `~`, making registry entries more portable across different user environments.

**Example**:
```json
{
  "env": {
    "PATTERNS_DIR": "${HOME}/icode/design-pattern-mcp/corpus"
  }
}
```

Would expand to `/Users/bmf/icode/design-pattern-mcp/corpus` on macOS.

#### Acceptance Criteria

- [ ] Support `${VAR}` and `$VAR` syntax for environment variable expansion
- [ ] Support `~` expansion to user home directory
- [ ] Handle nested variables (e.g., `$HOME/bin` where `HOME` is another env var)
- [ ] Document supported interpolation syntax
- [ ] Add tests for all interpolation cases
- [ ] Ensure security (no arbitrary command execution)

#### Technical Notes

**Implementation Approach**:
```python
import os
from pathlib import Path

def expand_env_value(value: str) -> str:
    """Expand environment variables and paths in value."""
    # Expand ~ to home directory
    if value.startswith("~"):
        value = str(Path(value).expanduser())

    # Expand environment variables
    value = os.path.expandvars(value)

    return value
```

**Security Considerations**:
- Only expand `$VAR` syntax, not `$(cmd)` command substitution
- Validate expanded paths exist before writing config
- Document security implications

**Why P2**:
- Not critical for initial env var support
- Adds complexity (security, cross-platform)
- Can be added incrementally in v2.1

---

## P3 (LOW) - Long-Term Improvements (Next Quarter)

### P3-1: Add Server-Specific Environment Variable Validation

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Dependencies**: P1-1 (env var support)
**Spec Reference**: N/A (Future enhancement)
**Status Reference**: N/A (New feature suggestion)

#### Description

Add schema-based validation of environment variables per server, allowing servers to declare required vs optional env vars and validation rules.

**Example Registry Entry**:
```json
{
  "design-patterns": {
    "description": "...",
    "command": "node",
    "args": ["..."],
    "env": {
      "PATTERNS_DIR": "/path/to/corpus"
    },
    "env_schema": {
      "PATTERNS_DIR": {
        "required": true,
        "type": "path",
        "must_exist": true,
        "description": "Absolute path to pattern corpus directory"
      }
    }
  }
}
```

#### Acceptance Criteria

- [ ] Add `env_schema` field to `MCPServer` model
- [ ] Validate env vars against schema on installation
- [ ] Provide clear error messages for invalid env vars
- [ ] Support validation types: path, url, string, number
- [ ] Support `must_exist` flag for path validation
- [ ] Generate helpful hints when validation fails

#### Technical Notes

**Why P3**:
- Nice-to-have, not critical for MVP
- Requires careful schema design
- May be overkill for most servers
- Better to gather feedback on P1 first

---

## Dependency Graph

```
P0-1: Update Claude Config (IMMEDIATE)
  └─> [ENABLES] P1-1: Add Env Var Support (provides test case)

P1-1: Add Env Var Support to MCPI
  ├─> [ENABLES] P2-1: Path Interpolation (builds on env var foundation)
  └─> [ENABLES] P3-1: Env Var Validation (builds on env var foundation)

P2-1: Path Interpolation
  └─> (no dependencies)

P3-1: Env Var Validation
  └─> (no dependencies)
```

**Critical Path**: P0-1 → P1-1 (Must complete P0-1 to validate P1-1 design)

**Parallel Work**: P2-1 and P3-1 can be done in any order after P1-1

---

## Recommended Sprint Planning

### Sprint 1: Immediate Fix + Planning (1 day)

**Scope**: Get server working NOW + validate approach

**Tasks**:
1. **P0-1**: Update `~/.claude.json` configuration (2 minutes)
2. **Verify**: Test server connection (5 minutes)
3. **P1-1 Design**: Design env var schema changes (2-3 hours)
4. **P1-1 Tests**: Write tests FIRST for env var support (3-4 hours)

**Deliverable**: Working server + Test-driven design for P1-1

**Why This Sprint**:
- Unblocks user immediately
- Validates the fix approach before implementing in MCPI
- Test-first design ensures quality implementation

### Sprint 2: Environment Variable Support (3-5 days)

**Scope**: Add complete env var support to MCPI

**Tasks**:
1. **Schema**: Add `env` field to Pydantic models (2 hours)
2. **Registry**: Update `data/registry.json` with design-patterns env (1 hour)
3. **Installation**: Update client plugins to use env vars (3-4 hours)
4. **Testing**: Integration tests for env var installation (3-4 hours)
5. **Documentation**: Update docs with env var usage (2-3 hours)
6. **Validation**: End-to-end test with design-patterns (1 hour)

**Deliverable**: Full env var support merged and tested

**Why This Sprint**:
- Complete feature implementation
- All existing functionality remains working
- Tests validate backward compatibility

### Sprint 3 (Optional): Path Interpolation (1-2 days)

**Scope**: Add path interpolation for portability

**Tasks**:
1. **Implementation**: Add path expansion logic (2-3 hours)
2. **Testing**: Test all interpolation cases (2-3 hours)
3. **Security**: Validate no command execution (1 hour)
4. **Documentation**: Document interpolation syntax (1 hour)

**Deliverable**: Path interpolation feature

**Why Optional**:
- Not critical for initial release
- Can be added in v2.1 based on user feedback

---

## Risk Assessment

### P0-1: Update Claude Config

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Config syntax error | Low | High | Validate JSON before saving, keep backup |
| Wrong path | Low | High | Copy exact path from evaluation report |
| Claude fails to reload | Low | Medium | Restart Claude Code entirely |
| Change reverted by Claude | Very Low | Medium | Document change, re-apply if needed |

**Overall Risk**: VERY LOW (trivial config change, easily reverted)

### P1-1: Add Env Var Support

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Breaking backward compat | Medium | Critical | Extensive regression testing, optional field |
| Schema validation failure | Low | Medium | Update all validators together |
| Cross-platform path issues | Medium | Medium | Document path best practices, test on multiple OS |
| Security (env var injection) | Low | High | Validate env var names, document security |

**Overall Risk**: LOW-MEDIUM (well-scoped feature, backward compatible design)

### P2-1: Path Interpolation

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Command injection | Medium | Critical | Only expand vars, not commands, security review |
| Inconsistent expansion | Medium | Medium | Test on all platforms, document behavior |
| Breaking existing configs | Low | Medium | Make interpolation opt-in, don't auto-expand |

**Overall Risk**: MEDIUM (security concerns require careful implementation)

---

## Success Metrics

### Immediate Success (P0-1)

- [ ] design-patterns server shows "✓ Connected" in `claude mcp list`
- [ ] All 6 MCP tools available via `claude mcp tools design-patterns`
- [ ] Zero errors in Claude Code MCP logs
- [ ] User can query design pattern documentation successfully

### Feature Success (P1-1)

- [ ] `mcpi add design-patterns` creates working config (no manual edits)
- [ ] Test pass rate remains ≥92% (no regressions)
- [ ] All existing servers continue working (backward compatibility)
- [ ] Documentation clearly explains env var usage
- [ ] At least 2 registry entries use env vars (design-patterns + one more)

### Quality Metrics

- [ ] Zero breaking changes introduced
- [ ] All new code has unit tests (100% coverage)
- [ ] Integration tests cover happy path + edge cases
- [ ] Documentation updated (CLAUDE.md, README, CHANGELOG)
- [ ] Code review passed (SOLID principles maintained)

---

## File Management

### Planning File Retention

**Current PLAN Files**:
- PLAN-2025-10-30-062544.md (Oct 30)
- PLAN-2025-11-07-052005.md (Nov 7)
- PLAN-2025-11-09-052500.md (Nov 9) ← THIS FILE

**Count**: 3 files (within 4-file limit)

**Action**: No deletion required (3 < 4)

**Next Cleanup**: When 5th PLAN file created, delete PLAN-2025-10-30-062544.md (oldest)

### Archive Conflicts

**Check for Conflicting Artifacts**:
- No obsolete planning files detected
- BACKLOG.md is current (2025-11-07)
- STATUS files managed separately (4-file limit)
- No archive action required

---

## Implementation Notes

### Code Changes Required (P1-1)

**Files to Modify**:
1. `src/mcpi/registry/catalog.py` - Add `env` field to `MCPServer` model
2. `src/mcpi/clients/claude_code.py` - Include env vars in config generation
3. `src/mcpi/clients/cursor.py` - Include env vars in config generation (if different)
4. `src/mcpi/clients/vscode.py` - Include env vars in config generation (if different)
5. `data/registry.json` - Update design-patterns entry with env var
6. `tests/test_registry.py` - Add tests for env field validation
7. `tests/test_cli_integration.py` - Add tests for env var installation
8. `CLAUDE.md` - Document env var support
9. `README.md` - Add env var example
10. `CHANGELOG.md` - Document new feature

**Files to Create**:
1. `tests/test_env_var_support.py` - Dedicated test suite for env vars (recommended)

**Estimated Lines of Code**:
- Pydantic model: ~5 lines
- Installation logic: ~10-15 lines per client (3 clients = 30-45 lines)
- Tests: ~100-150 lines
- Documentation: ~50-75 lines
- **Total**: ~200-250 lines

### Testing Approach

**Test-Driven Development** (Recommended):

1. **Write Tests First** (Sprint 1):
   ```python
   # tests/test_env_var_support.py

   def test_mcpserver_accepts_env_field():
       """MCPServer model should accept env field."""
       server = MCPServer(
           description="Test",
           command="node",
           args=["server.js"],
           env={"VAR": "value"}
       )
       assert server.env == {"VAR": "value"}

   def test_installation_includes_env_vars():
       """Installation should include env vars in config."""
       # ... test implementation
   ```

2. **Implement Until Tests Pass** (Sprint 2)

3. **Add Integration Tests** (Sprint 2)

4. **Manual Verification** (Sprint 2)

**Why Test-First**:
- Clarifies requirements before coding
- Prevents over-engineering
- Ensures testable design
- Fast feedback loop

---

## Conclusion

This plan addresses both the immediate need (fix design-patterns server) and the long-term improvement (add env var support to MCPI). The work is structured as:

**P0 (CRITICAL)**: Manual config fix to unblock user NOW (2 minutes)

**P1 (HIGH)**: Add env var support to MCPI to prevent this issue for all future servers (3-5 days)

**P2-P3 (OPTIONAL)**: Incremental improvements based on user feedback

**Total Effort**:
- P0: 2 minutes (immediate)
- P1: 3-5 days (next 2 weeks)
- P2: 1-2 days (optional)
- P3: 3-5 days (optional)

**Confidence**: HIGH (9/10)
- P0 is trivial (2-minute config edit)
- P1 is well-scoped (additive feature, backward compatible)
- Evidence from evaluation report confirms root cause
- Clear acceptance criteria and test strategy

**Next Action**: Execute P0-1 (update `~/.claude.json`) to unblock server immediately.

---

**END OF PLAN**

Generated: 2025-11-09 05:25:00
Author: Claude Code (Project Planner)
Project: MCPI (Model Context Protocol Interface)
Focus: Design Patterns MCP Server Connection Fix + Environment Variable Support
Priority: P0 (CRITICAL) + P1 (HIGH)
