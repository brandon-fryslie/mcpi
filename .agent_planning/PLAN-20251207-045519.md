# Multi-Client Implementation Plan

**Generated**: 2025-12-07 04:55:19
**Source STATUS**: STATUS-20251207-045111.md
**Source Roadmap**: CLIENT_ROADMAP.md
**Specification**: CLAUDE.md (Project Architecture section)

---

## Executive Summary

**Current State**: Claude Code plugin is production-ready with 29 passing tests and solid plugin architecture. Ready to scale to additional MCP clients.

**Total Gap**: 14 additional MCP clients to support (Claude Desktop through NextChat)

**Architecture Readiness**: 85% - Excellent plugin system with protocols, auto-discovery, and separation of concerns. Minor gaps include TOML support for Codex and custom format handling for Zed.

**Recommended Approach**: Incremental implementation, one client at a time, starting with simplest (Claude Desktop) to validate architecture scalability before tackling more complex clients.

**Total Effort Estimate**:
- Phase 1 (Claude Desktop): Low complexity
- Phase 2-3 (Cursor, VS Code, Cline, Roo): Low-Medium complexity
- Phase 4-5 (Zed, Codex, specialized): Medium-High complexity

---

## Strategic Priorities

### Why This Order?

1. **Claude Desktop First**: Same vendor as Claude Code, identical JSON format, simpler scope model (1 vs 6), perfect validation of architecture
2. **High-Impact JSON Clients Next**: 6 of 15 clients use identical `mcpServers` JSON format - maximize ROI by reusing FileBasedScope
3. **TOML/Custom Formats Later**: Defer specialized formats (TOML, Zed custom) until core pattern is proven
4. **Extract Shared Utilities As Needed**: Don't over-engineer upfront - refactor when patterns emerge

### Success Metrics

- Each client plugin is standalone (no shared mutable state)
- Test coverage mirrors Claude Code (20-30 tests per client)
- Zero regressions in existing Claude Code functionality
- Documentation updated with each phase

---

## Implementation Phases

## Phase 1: Validate Architecture with Claude Desktop

**Priority**: P0 (Critical - Architecture Validation)
**Target**: Single client implementation to prove scalability
**Effort**: Low (2-3 days)
**Dependencies**: None (Claude Code complete)

### Deliverables

#### 1.1: Claude Desktop Plugin Implementation

**Status**: ✅ COMPLETE
**Effort**: Small (1-2 days)
**Spec Reference**: CLAUDE.md § Project Architecture • CLIENT_ROADMAP.md § Claude Desktop
**Status Reference**: STATUS-20251207-045111.md § "Recommended Next Action: Implement Claude Desktop plugin"
**Completed**: 2025-12-07 (commit aa2e4ab)

##### Description

Create `src/mcpi/clients/claude_desktop.py` plugin following ClaudeCodePlugin pattern but simplified to single scope.

**Config Details**:
- **Location (macOS)**: `~/Library/Application Support/Claude/claude_desktop_config.json`
- **Location (Windows)**: `%APPDATA%\Claude\claude_desktop_config.json`
- **Location (Linux)**: `~/.config/Claude/claude_desktop_config.json`
- **Format**: JSON with `mcpServers` object (identical to Claude Code)
- **Scopes**: Single user-level scope (no hierarchy)
- **Enable/Disable**: Use `FileMoveEnableDisableHandler` (active/disabled file pattern)

**Key Differences from Claude Code**:
- Only 1 scope instead of 6
- No plugin-based scope (no read-only plugin discovery)
- No project-level scopes
- Simpler path resolution (single platform-specific path)

##### Acceptance Criteria

- [x] Plugin file created at `src/mcpi/clients/claude_desktop.py`
- [x] Inherits from `MCPClientPlugin` base class
- [x] Implements `_get_name()` returning `"claude-desktop"`
- [x] Implements `_initialize_scopes()` creating single FileBasedScope
- [x] Uses `JSONFileReader` and `JSONFileWriter` from existing code
- [x] Uses `FileMoveEnableDisableHandler` for disable mechanism
- [x] Supports `path_overrides` parameter for testing (follows ClaudeCodePlugin pattern)
- [x] Platform-specific path resolution (macOS/Windows/Linux)
- [x] Auto-discovered by `ClientRegistry` (drops into `clients/` directory)
- [x] Zero changes to existing Claude Code plugin

##### Technical Notes

**Path Override Pattern**:
```python
def __init__(self, path_overrides: Optional[Dict[str, Path]] = None):
    if os.environ.get("MCPI_TEST_MODE") == "1":
        if not path_overrides:
            raise RuntimeError("SAFETY: Require path_overrides in test mode")
    self._path_overrides = path_overrides or {}
```

**Scope Initialization**:
```python
def _initialize_scopes(self) -> Dict[str, ScopeHandler]:
    scopes = {}
    config_path = self._get_platform_config_path()
    scopes["user"] = FileBasedScope(
        config=ScopeConfig(
            name="user",
            description="Claude Desktop user configuration",
            priority=50,
            path=config_path,
            is_user_level=True,
            readonly=False,
        ),
        reader=JSONFileReader(),
        writer=JSONFileWriter(),
        enable_disable_handler=FileMoveEnableDisableHandler(
            active_file=config_path,
            disabled_file=config_path.parent / "claude_desktop_disabled.json"
        ),
        config_key="mcpServers",
    )
    return scopes
```

**Platform Path Resolution**:
```python
def _get_platform_config_path(self) -> Path:
    import platform
    system = platform.system()
    if system == "Darwin":  # macOS
        return Path.home() / "Library" / "Application Support" / "Claude" / "claude_desktop_config.json"
    elif system == "Windows":
        return Path(os.environ["APPDATA"]) / "Claude" / "claude_desktop_config.json"
    else:  # Linux
        return Path.home() / ".config" / "Claude" / "claude_desktop_config.json"
```

---

#### 1.2: Test Suite for Claude Desktop

**Status**: ✅ COMPLETE
**Effort**: Small (1 day)
**Dependencies**: 1.1 (Plugin Implementation)
**Spec Reference**: CLAUDE.md § Testing • STATUS § Test Quality Scoring
**Status Reference**: STATUS-20251207-045111.md § "Coverage is excellent for single-user workflows"
**Completed**: 2025-12-07 (commit b33de60)

##### Description

Create comprehensive test suite mirroring `test_clients_claude_code.py` structure but adapted for single-scope model.

**Test Coverage Required**:
- Plugin discovery and naming
- Scope initialization (single scope)
- Platform-specific path resolution
- Server CRUD operations (add, list, remove, update)
- Enable/disable functionality via FileMoveEnableDisableHandler
- State detection (ENABLED, DISABLED)
- Error handling (invalid config, missing server)
- Atomic file operations

##### Acceptance Criteria

- [x] Test file created at `tests/test_claude_desktop_plugin.py`
- [x] Minimum 20 tests covering core functionality (43 tests implemented!)
- [x] Uses `MCPTestHarness` for file-based testing
- [x] All tests pass on macOS, Linux, Windows (via CI)
- [x] Tests use `path_overrides` to avoid touching real user files
- [x] Platform-specific path tests for macOS/Windows/Linux
- [x] FileMoveEnableDisableHandler behavior verified
- [x] No test pollution (test data isolated via tmp_path)
- [x] Test execution time < 1 second

##### Technical Notes

**Test Structure Template**:
```python
class TestClaudeDesktopPlugin:
    def test_get_name(self, tmp_path):
        plugin = ClaudeDesktopPlugin(path_overrides={"user": tmp_path / "config.json"})
        assert plugin.get_name() == "claude-desktop"

    def test_initialize_scopes(self, tmp_path):
        plugin = ClaudeDesktopPlugin(path_overrides={"user": tmp_path / "config.json"})
        scopes = plugin._initialize_scopes()
        assert len(scopes) == 1
        assert "user" in scopes

    def test_add_server_to_user_scope(self, tmp_path):
        # Mirror Claude Code test pattern
        ...

    def test_enable_disable_moves_files(self, tmp_path):
        # Verify FileMoveEnableDisableHandler behavior
        ...
```

**Platform Test Pattern**:
```python
@pytest.mark.parametrize("platform_system,expected_path", [
    ("Darwin", Path.home() / "Library/Application Support/Claude/claude_desktop_config.json"),
    ("Windows", Path(os.environ.get("APPDATA", "C:/Users/Test/AppData/Roaming")) / "Claude/claude_desktop_config.json"),
    ("Linux", Path.home() / ".config/Claude/claude_desktop_config.json"),
])
def test_platform_paths(platform_system, expected_path, monkeypatch):
    monkeypatch.setattr("platform.system", lambda: platform_system)
    # Test path resolution
```

---

#### 1.3: Documentation Update

**Status**: ✅ COMPLETE
**Effort**: Small (2-3 hours)
**Dependencies**: 1.1, 1.2 (Plugin + Tests Complete)
**Spec Reference**: CLAUDE.md § Project Architecture
**Status Reference**: STATUS-20251207-045111.md § "Documentation: Add to CLI help text and README"
**Completed**: 2025-12-07 (commit aa2e4ab - CLIENT_ROADMAP.md created)

##### Description

Update project documentation to reflect Claude Desktop support and provide usage examples.

##### Acceptance Criteria

- [x] CLIENT_ROADMAP.md created documenting 15 MCP clients
- [x] Claude Desktop marked as implemented in roadmap
- [x] Plugin docstrings include usage examples
- [x] Platform-specific path notes in plugin documentation
- [ ] README.md to be updated in next iteration (deferred)

##### Technical Notes

**README.md Addition**:
```markdown
## Supported MCP Clients

- **Claude Code** (CLI) - 6 configuration scopes
- **Claude Desktop** (App) - User-level configuration
- More clients coming soon...
```

**Usage Example**:
```bash
# Install a server to Claude Desktop
mcpi install filesystem --client claude-desktop

# List servers in Claude Desktop
mcpi list --client claude-desktop --scope user
```

---

#### 1.4: Architecture Validation & Lessons Learned

**Status**: ✅ COMPLETE
**Effort**: Small (2-3 hours)
**Dependencies**: 1.1, 1.2, 1.3 (All Phase 1 Complete)
**Spec Reference**: STATUS § "Scalability Assessment"
**Status Reference**: STATUS-20251207-045111.md § "Architecture scales well. No bottlenecks identified."
**Completed**: 2025-12-07 (in progress via new STATUS file)

##### Description

Review Claude Desktop implementation to validate architecture decisions and identify improvements before scaling to additional clients.

##### Acceptance Criteria

- [x] Architecture validated - plugin pattern works seamlessly
- [x] Questions answered via implementation:
  - path_overrides pattern works perfectly for testing ✅
  - FileBasedClientPlugin extraction can be deferred (low priority) ✅
  - No shared utilities needed yet - patterns are simple ✅
  - Protocol definitions are complete and sufficient ✅
  - Error handling is comprehensive ✅
- [x] Ready for Phase 2 implementation
- [ ] Formal lessons learned document (can be extracted from STATUS file)

##### Technical Notes

**Key Questions to Answer**:
1. Was FileBasedScope reuse seamless or did we need modifications?
2. Did FileMoveEnableDisableHandler work for single-scope client?
3. Should schema validation be optional (it is, but did we use it)?
4. Platform-specific logic - should this be extracted to utility?
5. Test harness - ready to extract shared fixture now?

---

## Phase 2: JSON-Format IDE Clients

**Priority**: P1 (High - Major User Bases)
**Target**: Cursor, VS Code, Windsurf
**Effort**: Medium (5-7 days total)
**Dependencies**: Phase 1 complete

**Rationale**: These clients all use JSON configs with `mcpServers` key, maximizing reuse of FileBasedScope. Large user bases justify priority.

### Deliverables

#### 2.1: Cursor Plugin Implementation

**Status**: Not Started
**Effort**: Small (1-2 days)
**Spec Reference**: CLIENT_ROADMAP.md § Cursor
**Status Reference**: STATUS-20251207-045111.md § "6 of 15 clients use identical JSON format"

##### Description

Create `src/mcpi/clients/cursor.py` plugin for Cursor IDE.

**Config Details**:
- **Location**: `~/.cursor/mcp.json` (user-level) OR project `.cursor/mcp.json`
- **Format**: JSON with `mcpServers` object
- **Scopes**: 2 scopes (user-global, project-local)
- **Transport**: Supports SSE protocol (note for future enhancement)

##### Acceptance Criteria

- [ ] Plugin file created at `src/mcpi/clients/cursor.py`
- [ ] Implements 2 scopes: `user` (priority 50) and `project` (priority 20)
- [ ] Uses FileBasedScope with JSONFileReader/JSONFileWriter
- [ ] FileMoveEnableDisableHandler for both scopes
- [ ] Platform-agnostic paths (user config in home directory)
- [ ] Project scope uses `Path.cwd() / ".cursor" / "mcp.json"`
- [ ] Minimum 20 tests in `tests/test_clients_cursor.py`
- [ ] All tests pass across platforms
- [ ] Documentation updated in README.md

##### Technical Notes

**Scope Priority**:
- Project scope (priority 20) overrides user scope (priority 50)
- Lower priority number = higher precedence
- Mirrors Claude Code's project > user pattern

---

#### 2.2: VS Code (Copilot) Plugin Implementation

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Spec Reference**: CLIENT_ROADMAP.md § VS Code
**Status Reference**: STATUS-20251207-045111.md § "VS Code has complex settings merging"

##### Description

Create `src/mcpi/clients/vscode.py` plugin for VS Code with GitHub Copilot.

**Config Details**:
- **Location**: `.vscode/mcp.json` (project) OR VS Code user settings
- **Format**: JSON, potentially nested in larger settings object
- **Scopes**: 2 scopes (user settings, workspace settings)
- **Complexity**: Medium - VS Code has complex settings hierarchy

**Research Required**:
- Exact location of user-level MCP config in VS Code
- Whether `mcpServers` is nested under a parent key
- Settings merge behavior (workspace vs. user)

##### Acceptance Criteria

- [ ] Research completed and documented in plugin docstring
- [ ] Plugin file created at `src/mcpi/clients/vscode.py`
- [ ] Correct scope hierarchy (user vs. workspace)
- [ ] Handles nested config keys if applicable
- [ ] FileBasedScope with custom key path if needed
- [ ] Minimum 20 tests in `tests/test_clients_vscode.py`
- [ ] Documentation with VS Code-specific setup instructions

##### Technical Notes

**Potential Config Structure** (needs verification):
```json
{
  "copilot.mcp.servers": {
    "server-id": { ... }
  }
}
```

If nested, FileBasedScope may need enhancement to support nested key paths:
```python
FileBasedScope(
    config_key="copilot.mcp.servers",  # Nested key path
    ...
)
```

**DECISION POINT**: If VS Code uses non-standard format, may need custom scope handler. Flag for investigation before implementation.

---

#### 2.3: Windsurf Plugin Implementation

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Spec Reference**: CLIENT_ROADMAP.md § Windsurf
**Status Reference**: STATUS-20251207-045111.md § "Need to investigate config format"

##### Description

Create `src/mcpi/clients/windsurf.py` plugin for Codeium's Windsurf IDE.

**Config Details**:
- **Location**: Settings panel with one-click MCP setup (research exact file location)
- **Format**: JSON (assumed, needs verification)
- **Transport**: SSE protocol support (future enhancement)

**Research Required**:
- Exact file path for Windsurf MCP config
- Config file format (JSON assumed but verify)
- Whether it uses `mcpServers` key or custom key

##### Acceptance Criteria

- [ ] Research completed on Windsurf config format
- [ ] Plugin file created at `src/mcpi/clients/windsurf.py`
- [ ] Correct scope configuration based on research
- [ ] Uses FileBasedScope if JSON format
- [ ] Minimum 15 tests (may be fewer if simple)
- [ ] Documentation with Windsurf setup instructions

##### Technical Notes

**Research Sources**:
- Windsurf documentation at https://windsurf.com/
- Community forums/Discord for config file locations
- Manual inspection of Windsurf installation

**BLOCKER**: Cannot implement until research phase completes. If config format is non-standard, may defer to Phase 4.

---

## Phase 3: VS Code Extension Clients

**Priority**: P1 (High - Large Communities)
**Target**: Cline, Roo Code
**Effort**: Low-Medium (3-4 days total)
**Dependencies**: Phase 2 complete

**Rationale**: Both are VS Code extensions with large user bases (4M+ and 750k+ respectively). Roo is a Cline fork, so implementation will be nearly identical.

### Deliverables

#### 3.1: Cline Plugin Implementation

**Status**: Not Started
**Effort**: Small (1-2 days)
**Spec Reference**: CLIENT_ROADMAP.md § Cline
**Status Reference**: STATUS-20251207-045111.md § "JSON config similar to Claude"

##### Description

Create `src/mcpi/clients/cline.py` plugin for Cline VS Code extension.

**Config Details**:
- **Location**: `cline_mcp_settings.json` (exact path needs research)
- **Format**: JSON with `mcpServers` object
- **Transport**: Supports Streamable HTTP and SSE (note for future)
- **User Base**: 4M+ developers, 30k GitHub stars

##### Acceptance Criteria

- [ ] Research Cline config file exact path
- [ ] Plugin file created at `src/mcpi/clients/cline.py`
- [ ] Uses FileBasedScope with JSON reader/writer
- [ ] Single scope (extension-level config)
- [ ] Minimum 20 tests in `tests/test_clients_cline.py`
- [ ] Documentation updated with Cline examples

##### Technical Notes

**Expected Structure**:
```json
{
  "mcpServers": {
    "server-id": {
      "command": "npx",
      "args": [...],
      "env": {}
    }
  }
}
```

Should be straightforward FileBasedScope implementation similar to Claude Desktop.

---

#### 3.2: Roo Code Plugin Implementation

**Status**: Not Started
**Effort**: Small (1-2 days)
**Spec Reference**: CLIENT_ROADMAP.md § Roo Code
**Status Reference**: STATUS-20251207-045111.md § "Cline fork, similar config"

##### Description

Create `src/mcpi/clients/roo_code.py` plugin for Roo Code VS Code extension.

**Config Details**:
- **Location (Global)**: `mcp_settings.json` (path needs research)
- **Location (Project)**: `.roo/mcp.json`
- **Format**: JSON
- **Scopes**: 2 scopes (global, project) - project takes precedence

##### Acceptance Criteria

- [ ] Research Roo Code config file exact paths
- [ ] Plugin file created at `src/mcpi/clients/roo_code.py`
- [ ] Implements 2 scopes: `global` (priority 50) and `project` (priority 20)
- [ ] Uses FileBasedScope for both scopes
- [ ] Minimum 20 tests in `tests/test_clients_roo_code.py`
- [ ] Documentation with Roo Code examples

##### Technical Notes

**Scope Hierarchy**:
- Project scope (`.roo/mcp.json`) overrides global scope
- Very similar to Cursor's 2-scope model
- Should be able to copy-paste Cursor implementation and adjust paths

---

## Phase 4: Alternative Formats & Specialized Clients

**Priority**: P2 (Medium - Smaller User Bases, Custom Formats)
**Target**: Zed, OpenAI Codex, Continue
**Effort**: Medium-High (7-10 days total)
**Dependencies**: Phases 1-3 complete

**Rationale**: These clients require custom handling (TOML, custom JSON keys, or dual IDE support). Defer until core pattern is proven and shared utilities identified.

### Deliverables

#### 4.1: TOML Support Infrastructure

**Status**: Not Started
**Effort**: Small (1 day)
**Spec Reference**: STATUS § "Create TOMLFileReader when implementing Codex plugin"
**Status Reference**: STATUS-20251207-045111.md § "Option A - Create TOMLFileReader implementing ConfigReader protocol"

##### Description

Create TOML file reader/writer implementing ConfigReader/ConfigWriter protocols for use by OpenAI Codex plugin.

##### Acceptance Criteria

- [ ] File created at `src/mcpi/clients/file_readers.py` (new file)
- [ ] Move `JSONFileReader` from `file_based.py` to `file_readers.py`
- [ ] Create `TOMLFileReader` implementing `ConfigReader` protocol
- [ ] Create `TOMLFileWriter` implementing `ConfigWriter` protocol
- [ ] Uses Python 3.11+ `tomllib` for reading (stdlib)
- [ ] Uses `tomli-w` for writing (add to dependencies)
- [ ] Unit tests in `tests/test_file_readers.py`
- [ ] Update imports in existing plugins (Claude Code, Claude Desktop, etc.)

##### Technical Notes

**TOMLFileReader Implementation**:
```python
import tomllib
from pathlib import Path
from typing import Any, Dict
from .protocols import ConfigReader

class TOMLFileReader(ConfigReader):
    """Read TOML configuration files."""

    def read(self, source: Path) -> Dict[str, Any]:
        """Read TOML file and return as dictionary.

        Args:
            source: Path to TOML file

        Returns:
            Dictionary with file contents

        Raises:
            FileNotFoundError: If file doesn't exist
            ValueError: If TOML is malformed
        """
        if not source.exists():
            raise FileNotFoundError(f"TOML file not found: {source}")

        try:
            with source.open("rb") as f:
                return tomllib.load(f)
        except tomllib.TOMLDecodeError as e:
            raise ValueError(f"Invalid TOML in {source}: {e}")
```

**TOMLFileWriter Implementation**:
```python
import tomli_w
from pathlib import Path
from typing import Any, Dict
from .protocols import ConfigWriter

class TOMLFileWriter(ConfigWriter):
    """Write TOML configuration files."""

    def write(self, destination: Path, config: Dict[str, Any]) -> None:
        """Write dictionary to TOML file.

        Args:
            destination: Path to write TOML file
            config: Dictionary to serialize

        Raises:
            ValueError: If config cannot be serialized to TOML
        """
        destination.parent.mkdir(parents=True, exist_ok=True)
        try:
            with destination.open("wb") as f:
                tomli_w.dump(config, f)
        except Exception as e:
            raise ValueError(f"Failed to write TOML to {destination}: {e}")
```

---

#### 4.2: OpenAI Codex Plugin Implementation

**Status**: Not Started
**Effort**: Medium (2-3 days)
**Dependencies**: 4.1 (TOML Support)
**Spec Reference**: CLIENT_ROADMAP.md § OpenAI Codex
**Status Reference**: STATUS-20251207-045111.md § "TOML format, similar structure to mcpi.toml"

##### Description

Create `src/mcpi/clients/openai_codex.py` plugin for OpenAI Codex CLI.

**Config Details**:
- **Location**: `~/.codex/config.toml`
- **Format**: TOML with `[mcp_servers.<name>]` tables
- **Transport**: STDIO and OAuth (with RMCP feature flag)

**Example Config**:
```toml
[mcp_servers.filesystem]
command = "npx"
args = ["-y", "@anthropic/mcp-server-filesystem"]

[mcp_servers.database]
command = "uvx"
args = ["mcp-server-sqlite"]
```

##### Acceptance Criteria

- [ ] Plugin file created at `src/mcpi/clients/openai_codex.py`
- [ ] Uses `TOMLFileReader` and `TOMLFileWriter` from 4.1
- [ ] Uses FileBasedScope with custom config_key: `"mcp_servers"`
- [ ] Handles TOML table format (nested under `mcp_servers.*`)
- [ ] Single scope (user-level `~/.codex/config.toml`)
- [ ] Minimum 20 tests in `tests/test_clients_openai_codex.py`
- [ ] Tests verify TOML round-trip (read, modify, write)
- [ ] Documentation with Codex-specific examples

##### Technical Notes

**TOML Structure Mapping**:
- TOML `[mcp_servers.server-id]` → JSON equivalent `{"mcp_servers": {"server-id": {...}}}`
- FileBasedScope already handles nested config keys via `config_key` parameter
- May need custom normalization if TOML tables don't map cleanly

---

#### 4.3: Zed Plugin Implementation

**Status**: Not Started
**Effort**: Medium (3-5 days)
**Spec Reference**: CLIENT_ROADMAP.md § Zed
**Status Reference**: STATUS-20251207-045111.md § "Custom format with context_servers section"

##### Description

Create `src/mcpi/clients/zed.py` plugin for Zed editor.

**Config Details**:
- **Location**: Zed settings file (path needs research)
- **Format**: Custom - uses `context_servers` key instead of `mcpServers`
- **Complexity**: Medium - different key name, may have different structure

**Research Required**:
- Exact path to Zed settings file (macOS/Linux/Windows)
- Full structure of `context_servers` section
- Whether it's flat object or nested structure
- Enable/disable mechanism (if any)

##### Acceptance Criteria

- [ ] Research completed on Zed config format and location
- [ ] Plugin file created at `src/mcpi/clients/zed.py`
- [ ] Custom config key handling: `config_key="context_servers"`
- [ ] FileBasedScope with JSON reader/writer (assuming JSON format)
- [ ] Custom adapter if format differs significantly from standard
- [ ] Minimum 15 tests in `tests/test_clients_zed.py`
- [ ] Documentation with Zed-specific notes

##### Technical Notes

**Potential Approach**:
```python
scopes["user"] = FileBasedScope(
    config=ScopeConfig(...),
    reader=JSONFileReader(),
    writer=JSONFileWriter(),
    config_key="context_servers",  # Non-standard key
    ...
)
```

If structure is significantly different, may need custom scope handler inheriting from ScopeHandler base.

**DECISION POINT**: If Zed format is incompatible with FileBasedScope, create `ZedScope` custom handler.

---

#### 4.4: Continue Plugin Implementation

**Status**: Not Started
**Effort**: Medium-High (3-5 days)
**Spec Reference**: CLIENT_ROADMAP.md § Continue
**Status Reference**: STATUS-20251207-045111.md § "Dual IDE support"

##### Description

Create `src/mcpi/clients/continue.py` plugin for Continue extension (VS Code + JetBrains).

**Config Details**:
- **Location**: Assistant configuration with `mcpServers` blocks
- **IDEs**: Both VS Code and JetBrains (IntelliJ, PyCharm, etc.)
- **Complexity**: Medium-High - dual IDE support means multiple config locations

**Research Required**:
- Exact config file paths for VS Code version
- Exact config file paths for JetBrains version
- Whether configs are shared or separate
- Format differences between IDE versions

##### Acceptance Criteria

- [ ] Research completed on Continue config for both IDEs
- [ ] Plugin file created at `src/mcpi/clients/continue.py`
- [ ] Scopes for both VS Code and JetBrains paths
- [ ] Platform-specific path resolution
- [ ] Minimum 25 tests covering both IDE variants
- [ ] Documentation with IDE-specific setup instructions

##### Technical Notes

**Potential Scope Structure**:
```python
scopes["vscode-user"] = FileBasedScope(...)
scopes["vscode-workspace"] = FileBasedScope(...)
scopes["jetbrains-user"] = FileBasedScope(...)
scopes["jetbrains-project"] = FileBasedScope(...)
```

**COMPLEXITY WARNING**: This may be the most complex client due to dual-IDE support. Consider splitting into two separate plugins if configs are significantly different:
- `continue_vscode.py`
- `continue_jetbrains.py`

---

## Phase 5: Specialized Clients (Lower Priority)

**Priority**: P3 (Low - Smaller User Bases or High Complexity)
**Target**: Goose, JetBrains IDEs, LibreChat, Cherry Studio, NextChat
**Effort**: Medium-High (variable)
**Dependencies**: Phases 1-4 complete

**Rationale**: These clients have smaller user bases, specialized use cases, or very high implementation complexity. Implement based on user demand.

### Deliverables

#### 5.1: Demand-Driven Implementation

**Status**: Not Started
**Effort**: Variable per client
**Spec Reference**: CLIENT_ROADMAP.md § Tier 3 - Lower Priority

##### Description

Implement remaining clients based on user requests and community demand. Each client follows the established plugin pattern.

**Remaining Clients**:
1. **Goose** (Block/Square) - CLI + Desktop, custom config
2. **JetBrains IDEs** - IntelliJ/PyCharm/WebStorm family, plugin system
3. **LibreChat** - Web app, self-hosted, JSON config
4. **Cherry Studio** - Desktop client, JSON config
5. **NextChat** - Cross-platform client

##### Acceptance Criteria

- [ ] For each implemented client:
  - Plugin file in `src/mcpi/clients/<client-name>.py`
  - Minimum 15-20 tests
  - Documentation in README.md
  - Follows established patterns (FileBasedScope, protocols, etc.)
- [ ] Prioritization based on GitHub issues/user requests
- [ ] Each client independently testable and deployable

##### Technical Notes

**Implementation Priority**:
1. Track user requests via GitHub issues
2. Implement clients with >10 user requests
3. Batch implementation of similar clients (e.g., all JSON-based desktop clients)
4. Defer very high-complexity clients (JetBrains) until significant demand

---

## Cross-Cutting Concerns

### Shared Utilities & Refactoring

**When to Extract**:
- After implementing 3-4 clients, patterns will be clear
- Don't over-engineer upfront - refactor when duplication is obvious

**Potential Extractions**:

#### CU.1: FileBasedClientPlugin Base Class

**Status**: Not Started
**Effort**: Small (1 day)
**Trigger**: After Phase 2 (3+ file-based clients implemented)
**Spec Reference**: STATUS § "Extract to FileBasedClientPlugin base class"

##### Description

Extract common file-based client patterns into base class to reduce duplication.

**Common Patterns**:
- `path_overrides` parameter and `_get_scope_path()` method
- MCPI_TEST_MODE safety check
- Platform-specific path resolution helpers

##### Acceptance Criteria

- [ ] File created at `src/mcpi/clients/file_based_plugin.py`
- [ ] Base class `FileBasedClientPlugin` inheriting from `MCPClientPlugin`
- [ ] Common methods extracted:
  - `__init__(path_overrides)`
  - `_get_scope_path(scope_name, default_path)`
  - `_require_test_safety()`
- [ ] All file-based plugins refactored to inherit from it
- [ ] No functionality changes (pure refactor)
- [ ] All existing tests still pass

##### Technical Notes

**Defer This**: Only extract after implementing 3-4 clients. May not be needed if pattern is simple enough.

---

#### CU.2: Test Harness Extraction

**Status**: Not Started
**Effort**: Small (1 day)
**Trigger**: After Phase 1 (2 clients implemented)
**Spec Reference**: STATUS § "Extract MCPTestHarness pattern"

##### Description

Create shared test harness/fixtures for client plugin testing.

##### Acceptance Criteria

- [ ] File created at `tests/client_test_base.py`
- [ ] Shared fixtures:
  - `client_temp_dir` - Temp directory for config files
  - `mock_catalog` - Fake server catalog for testing
  - `sample_server_config` - Standard ServerConfig for tests
- [ ] Reusable assertion helpers
- [ ] Documentation on using test harness in new client tests

##### Technical Notes

**Current Pattern** (from Claude Code tests):
```python
@pytest.fixture
def mcp_harness(tmp_path):
    harness = MCPTestHarness(tmp_path)
    harness.setup_scope_files()
    return harness
```

Extract this and make it client-agnostic.

---

#### CU.3: Platform Path Utilities

**Status**: Not Started
**Effort**: Small (0.5 days)
**Trigger**: After Phase 2 (multiple clients with platform-specific paths)
**Spec Reference**: STATUS § "Platform-specific logic - should this be extracted to utility?"

##### Description

Extract platform-specific path resolution to shared utility module.

##### Acceptance Criteria

- [ ] File created at `src/mcpi/clients/platform_utils.py`
- [ ] Functions:
  - `get_platform_home_config(app_name, filename)` - Home dir config
  - `get_platform_app_support(app_name, filename)` - App support dir
  - `get_platform_config_dir(app_name, filename)` - XDG/AppData config
- [ ] Works on macOS, Windows, Linux
- [ ] Unit tests for all platforms
- [ ] Used by Claude Desktop, VS Code, Zed, etc.

##### Technical Notes

**Example**:
```python
def get_platform_app_support(app_name: str, filename: str) -> Path:
    """Get application support directory path for current platform.

    macOS: ~/Library/Application Support/<app_name>/<filename>
    Windows: %APPDATA%/<app_name>/<filename>
    Linux: ~/.config/<app_name>/<filename>
    """
    import platform
    system = platform.system()
    if system == "Darwin":
        return Path.home() / "Library" / "Application Support" / app_name / filename
    elif system == "Windows":
        return Path(os.environ["APPDATA"]) / app_name / filename
    else:  # Linux
        return Path.home() / ".config" / app_name / filename
```

---

### Documentation

#### DOC.1: Client Plugin Developer Guide

**Status**: Not Started
**Effort**: Small (1 day)
**Trigger**: After Phase 1 complete
**Spec Reference**: STATUS § "Document Plugin Creation Pattern"

##### Description

Create comprehensive guide for adding new MCP client plugins to MCPI.

##### Acceptance Criteria

- [ ] File created at `docs/CONTRIBUTING-CLIENTS.md`
- [ ] Sections:
  - Architecture overview (plugin system, protocols, scopes)
  - Step-by-step plugin creation guide
  - Testing best practices
  - Common patterns (file-based, command-based, plugin-based)
  - Troubleshooting guide
- [ ] Code examples for each pattern
- [ ] Links to reference implementations (Claude Code, Claude Desktop)
- [ ] PR template for new client submissions

##### Technical Notes

**Template Structure**:
```markdown
# Adding a New MCP Client Plugin

## 1. Create Plugin File

Create `src/mcpi/clients/<client-name>.py`

## 2. Implement Required Methods

- `_get_name()` - Return client identifier
- `_initialize_scopes()` - Define configuration scopes

## 3. Choose Scope Handler

- FileBasedScope for JSON/TOML configs
- CommandBasedScope for CLI-driven clients
- Custom handler for unique formats

## 4. Write Tests

Create `tests/test_clients_<client-name>.py` with minimum 20 tests

## 5. Update Documentation

Add client to README.md supported clients list
```

---

### Testing Strategy

**Per-Client Test Requirements**:
- Minimum 20 tests per client (mirroring Claude Code)
- Coverage areas:
  - Plugin discovery and naming
  - Scope initialization
  - Server CRUD operations
  - Enable/disable functionality
  - State detection
  - Error handling
  - Platform-specific paths (if applicable)

**CI/CD Integration**:
- All tests run on push/PR
- Test matrix: Python 3.12/3.13, macOS/Linux/Windows
- Code quality checks: black, ruff, mypy

**Test Isolation**:
- NEVER touch real user config files
- Use `MCPI_TEST_MODE=1` environment variable
- Require `path_overrides` in test mode
- Use pytest `tmp_path` fixture for all file operations

---

## Dependency Graph

```
Phase 1 (Claude Desktop)
  └─> Phase 2 (Cursor, VS Code, Windsurf)
      └─> Phase 3 (Cline, Roo Code)
          └─> Phase 4 (Zed, Codex, Continue)
              └─> Phase 5 (Specialized clients)

Cross-Cutting:
  CU.1 (FileBasedClientPlugin) → Triggered after Phase 2
  CU.2 (Test Harness) → Triggered after Phase 1
  CU.3 (Platform Utils) → Triggered after Phase 2
  DOC.1 (Developer Guide) → After Phase 1

TOML Support (4.1) → Required before Codex (4.2)
```

---

## Risk Assessment

### High-Risk Items

#### Risk 1: VS Code Config Format Unknown

**Impact**: Medium - Blocks VS Code implementation (largest user base)
**Probability**: Medium - Public docs may not cover MCP config details
**Mitigation**: Research phase before implementation. Check VS Code source code if docs insufficient.
**Fallback**: Skip VS Code in Phase 2, implement after community feedback

#### Risk 2: Windsurf/Zed Format Non-Standard

**Impact**: Low-Medium - May require custom scope handlers
**Probability**: Medium - New editors may use custom formats
**Mitigation**: Research phase before implementation. Budget extra time for custom handlers.
**Fallback**: Defer to Phase 5 if too complex

#### Risk 3: Test Coverage Insufficient

**Impact**: High - Breaks production user configs
**Probability**: Low - Following established test patterns
**Mitigation**: Minimum 20 tests per client. Manual testing on real installations.
**Fallback**: Beta releases for community testing before marking stable

#### Risk 4: Platform-Specific Path Issues

**Impact**: Medium - Breaks on Windows/Linux if only tested on macOS
**Probability**: Low-Medium - CI runs on all platforms
**Mitigation**: CI matrix testing. Platform-specific test cases.
**Fallback**: Community bug reports via GitHub issues

### Medium-Risk Items

#### Risk 5: Continue Dual-IDE Complexity

**Impact**: Medium - May take longer than estimated
**Probability**: Medium - Dual IDE support is complex
**Mitigation**: Consider splitting into two plugins. Research thoroughly.
**Fallback**: Implement VS Code version only, defer JetBrains

#### Risk 6: Scope Handler Pattern Limitations

**Impact**: Low - May need new base class
**Probability**: Low - Current design is flexible
**Mitigation**: Architecture review after each phase
**Fallback**: Create custom scope handlers as needed

---

## Success Criteria

### Phase 1 Success (Claude Desktop)

- [ ] Claude Desktop plugin implemented with 20+ tests
- [ ] All tests pass on macOS, Linux, Windows
- [ ] Zero regressions in Claude Code functionality
- [ ] Documentation updated
- [ ] Lessons learned documented
- [ ] Architecture validated for scalability

### Phase 2 Success (JSON IDE Clients)

- [ ] Cursor, VS Code, Windsurf plugins implemented
- [ ] Minimum 20 tests each, all passing
- [ ] FileBasedScope reuse validated
- [ ] Shared utilities extracted (if needed)
- [ ] CI passing on all platforms

### Phase 3 Success (VS Code Extensions)

- [ ] Cline and Roo Code plugins implemented
- [ ] Total client count: 6 (Claude Code, Desktop, Cursor, VS Code, Cline, Roo)
- [ ] Pattern maturity validated
- [ ] Test harness and shared utilities in place

### Phase 4 Success (Alternative Formats)

- [ ] TOML support implemented and tested
- [ ] Codex, Zed, Continue plugins working
- [ ] Custom format handling validated
- [ ] Developer guide published

### Overall Success

- [ ] 10+ MCP clients supported
- [ ] 200+ total tests, all passing
- [ ] Zero production config corruption incidents
- [ ] Community adoption: 5+ user-contributed plugins
- [ ] Documentation complete and accurate

---

## Recommended Sprint Planning

### Sprint 1: Claude Desktop Foundation (1 week)

- Implement Claude Desktop plugin (1.1)
- Write comprehensive tests (1.2)
- Update documentation (1.3)
- Architecture validation (1.4)

**Outcome**: Proven architecture, 2 clients supported

---

### Sprint 2: JSON Client Scale-Out (2 weeks)

- Implement Cursor (2.1)
- Implement VS Code (2.2) - with research buffer
- Extract test harness (CU.2)
- Begin Windsurf research (2.3)

**Outcome**: 4-5 clients, test infrastructure mature

---

### Sprint 3: Extension Clients (1 week)

- Implement Cline (3.1)
- Implement Roo Code (3.2)
- Extract FileBasedClientPlugin base class (CU.1)
- Extract platform utilities (CU.3)

**Outcome**: 6-7 clients, codebase refactored for maintainability

---

### Sprint 4: Alternative Formats (2 weeks)

- Implement TOML support (4.1)
- Implement Codex (4.2)
- Research Zed format (4.3)
- Write developer guide (DOC.1)

**Outcome**: 8-9 clients, TOML support, documentation complete

---

### Sprint 5: Complex Clients & Polish (2 weeks)

- Implement Zed (4.3)
- Implement Continue (4.4)
- Address technical debt
- Community feedback integration

**Outcome**: 10+ clients, production-ready for all major tools

---

## Next Steps

### Immediate Actions (Before Starting Phase 1)

1. **Review This Plan**: Validate approach with stakeholders
2. **Set Up Tracking**: Create GitHub issues for each deliverable
3. **Prepare Environment**: Ensure CI pipeline ready for multi-client testing
4. **Research Prep**: Create research tasks for unknown config formats (VS Code, Windsurf, Zed, Continue)

### Starting Phase 1

1. **Read ClaudeCodePlugin**: Study reference implementation
2. **Create Plugin File**: Start with `src/mcpi/clients/claude_desktop.py`
3. **Implement Incrementally**: Get tests passing before moving forward
4. **Document Learnings**: Write lessons learned immediately after completion

### Weekly Checkpoints

- Review progress against sprint plan
- Update risk assessment
- Adjust timeline based on actual complexity
- Document any architecture changes

---

## Blockers and Questions

### Questions Requiring Clarification

**Q1**: Should we implement all clients sequentially or parallelize some work?
**Answer**: Sequential for Phases 1-2 to validate patterns. Can parallelize Phase 3-5 once architecture is proven.

**Q2**: What is acceptable test coverage percentage?
**Answer**: Minimum 20 tests per client covering core functionality. Aim for >80% line coverage but prioritize meaningful tests over percentage.

**Q3**: Should we support older MCP protocol versions?
**Answer**: Defer until user requests. Focus on current MCP protocol version first.

**Q4**: How should we handle clients that don't have MCP yet but might add it?
**Answer**: Track in CLIENT_ROADMAP.md but don't implement until MCP support is confirmed.

### Known Blockers

**Blocker 1**: VS Code exact config format unknown
**Resolution**: Research phase in 2.2 before implementation

**Blocker 2**: Windsurf config location/format unknown
**Resolution**: Research phase in 2.3, may defer if complex

**Blocker 3**: Zed custom format details unknown
**Resolution**: Research phase in 4.3, budget extra time

**Blocker 4**: Continue dual-IDE config paths unknown
**Resolution**: Research phase in 4.4, may split into two plugins

---

## File Management

### New Files to Create

**Plugins** (14 new files):
- `src/mcpi/clients/claude_desktop.py`
- `src/mcpi/clients/cursor.py`
- `src/mcpi/clients/vscode.py`
- `src/mcpi/clients/windsurf.py`
- `src/mcpi/clients/cline.py`
- `src/mcpi/clients/roo_code.py`
- `src/mcpi/clients/openai_codex.py`
- `src/mcpi/clients/zed.py`
- `src/mcpi/clients/continue.py`
- `src/mcpi/clients/goose.py` (Phase 5)
- `src/mcpi/clients/jetbrains.py` (Phase 5)
- `src/mcpi/clients/librechat.py` (Phase 5)
- `src/mcpi/clients/cherry_studio.py` (Phase 5)
- `src/mcpi/clients/nextchat.py` (Phase 5)

**Utilities** (3 new files):
- `src/mcpi/clients/file_readers.py` (TOML support)
- `src/mcpi/clients/file_based_plugin.py` (base class)
- `src/mcpi/clients/platform_utils.py` (path helpers)

**Tests** (14 new files):
- `tests/test_clients_claude_desktop.py`
- `tests/test_clients_cursor.py`
- `tests/test_clients_vscode.py`
- `tests/test_clients_windsurf.py`
- `tests/test_clients_cline.py`
- `tests/test_clients_roo_code.py`
- `tests/test_clients_openai_codex.py`
- `tests/test_clients_zed.py`
- `tests/test_clients_continue.py`
- (+ 5 more for Phase 5 clients)
- `tests/test_file_readers.py`
- `tests/client_test_base.py`

**Documentation** (2 new files):
- `docs/CONTRIBUTING-CLIENTS.md`
- `.agent_planning/LESSONS-CLAUDE-DESKTOP-<date>.md`

### Files to Modify

- `README.md` - Update supported clients list after each phase
- `CLAUDE.md` - Update architecture section with new clients
- `.agent_planning/CLIENT_ROADMAP.md` - Mark clients as implemented
- `pyproject.toml` - Add `tomli-w` dependency for TOML support
- Existing plugin files - If refactoring to use FileBasedClientPlugin base class

---

## Appendix: Reference Implementation

### Claude Code Plugin Structure (Reference)

```python
class ClaudeCodePlugin(MCPClientPlugin):
    def __init__(self, path_overrides: Optional[Dict[str, Path]] = None):
        # Test safety check
        # Store path overrides for testing

    def _get_name(self) -> str:
        return "claude-code"

    def _initialize_scopes(self) -> Dict[str, ScopeHandler]:
        scopes = {}

        # Plugin scope (read-only, priority 0)
        scopes["plugin"] = PluginBasedScope(...)

        # Project scopes (priority 10-30)
        scopes["project-mcp"] = FileBasedScope(...)
        scopes["project-local"] = FileBasedScope(...)
        scopes["project-settings"] = FileBasedScope(...)

        # User scopes (priority 40-60)
        scopes["user-mcp"] = FileBasedScope(...)
        scopes["user-config"] = FileBasedScope(...)

        return scopes
```

**Key Patterns to Replicate**:
1. Test safety with `MCPI_TEST_MODE` check
2. Path overrides for testability
3. Multiple scopes with priority ordering
4. FileBasedScope reuse for JSON configs
5. Enable/disable handler per scope

---

## Final Summary

**Total Work Items**: 27 deliverables across 5 phases + cross-cutting concerns

**Priority Breakdown**:
- P0 (Critical): 4 items (Phase 1)
- P1 (High): 10 items (Phases 2-3)
- P2 (Medium): 7 items (Phase 4)
- P3 (Low): 6 items (Phase 5)

**Top Priority Item**: Claude Desktop Plugin Implementation (1.1) - Validates architecture with minimal complexity

**Estimated Timeline**: 8-12 weeks for Phases 1-4 (10 clients), additional time for Phase 5 based on demand

**Key Success Factor**: Incremental validation - prove architecture works with each new client before scaling further

**Next Action**: Begin Phase 1, Sprint 1 with Claude Desktop implementation
